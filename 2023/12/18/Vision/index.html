<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Barcode&amp;#8195;&amp;#8195;”Barcode”（条形码）是一种用于储存和检索数据的图形标识符。它通常由一系列宽度和间隙不同的条和空组成，用于表示数字、字母和其他字符。条形码在商业、物流、库存管理和其他领域广泛应用，以提高数据的追踪和管理效率。 条形码的主要类型包括一维码（1D Barcode）和二维码（2D Barcode）。  一维码（1D Barcode）： 一维码是由一系列宽">
<meta property="og:type" content="article">
<meta property="og:title" content="一码归一码">
<meta property="og:url" content="https://tiantian.fyi/2023/12/18/Vision/index.html">
<meta property="og:site_name" content="白小咪">
<meta property="og:description" content="Barcode&amp;#8195;&amp;#8195;”Barcode”（条形码）是一种用于储存和检索数据的图形标识符。它通常由一系列宽度和间隙不同的条和空组成，用于表示数字、字母和其他字符。条形码在商业、物流、库存管理和其他领域广泛应用，以提高数据的追踪和管理效率。 条形码的主要类型包括一维码（1D Barcode）和二维码（2D Barcode）。  一维码（1D Barcode）： 一维码是由一系列宽">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_4.jpg">
<meta property="og:image" content="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_6.PNG">
<meta property="og:image" content="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_7.PNG">
<meta property="og:image" content="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_1.jpg">
<meta property="og:image" content="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_2.jpg">
<meta property="og:image" content="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_3.jpg">
<meta property="og:image" content="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_8.PNG">
<meta property="og:image" content="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_9.PNG">
<meta property="og:image" content="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_5.jpg">
<meta property="og:image" content="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_10.jpg">
<meta property="og:image" content="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_10.jpg">
<meta property="og:image" content="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_10.jpg">
<meta property="og:image" content="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_10.jpg">
<meta property="og:image" content="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_10.jpg">
<meta property="article:published_time" content="2023-12-18T11:58:32.000Z">
<meta property="article:modified_time" content="2023-12-18T11:58:32.000Z">
<meta property="article:author" content="YYLittleCat">
<meta property="article:tag" content="iOS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_4.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/images/mini-icon.svg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>一码归一码</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.0.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" "Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">归档</a></li>
         
          <li><a href="/tags">标签</a></li>
         
          <li><a href="/about">关于</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="下一篇 " href="/2023/11/14/badman/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部 " href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章 " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://tiantian.fyi/2023/12/18/Vision/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://tiantian.fyi/2023/12/18/Vision/&text=一码归一码"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://tiantian.fyi/2023/12/18/Vision/&title=一码归一码"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://tiantian.fyi/2023/12/18/Vision/&is_video=false&description=一码归一码"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=一码归一码&body=Check out this article: https://tiantian.fyi/2023/12/18/Vision/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://tiantian.fyi/2023/12/18/Vision/&title=一码归一码"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://tiantian.fyi/2023/12/18/Vision/&title=一码归一码"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://tiantian.fyi/2023/12/18/Vision/&title=一码归一码"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://tiantian.fyi/2023/12/18/Vision/&title=一码归一码"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://tiantian.fyi/2023/12/18/Vision/&name=一码归一码&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://tiantian.fyi/2023/12/18/Vision/&t=一码归一码"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Barcode"><span class="toc-number">1.</span> <span class="toc-text">Barcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#QR-Scanner"><span class="toc-number">2.</span> <span class="toc-text">QR Scanner</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vision"><span class="toc-number">3.</span> <span class="toc-text">Vision</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#VNImageRequestHandler"><span class="toc-number">3.1.</span> <span class="toc-text">VNImageRequestHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E5%BD%A2%E7%A0%81%E7%9A%84%E8%83%8C%E6%99%AF%E8%89%B2"><span class="toc-number">3.2.</span> <span class="toc-text">条形码的背景色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%8B%E5%8A%A8%E7%9A%84%E5%B0%8F%E7%AE%AD%E5%A4%B4"><span class="toc-number">3.3.</span> <span class="toc-text">律动的小箭头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%91%E7%9A%84%E5%B0%8F%E6%83%85%E6%80%80"><span class="toc-number">3.4.</span> <span class="toc-text">我的小情怀</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">代码</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        一码归一码
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">YYLittleCat</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-12-18T11:58:32.000Z" itemprop="datePublished">2023-12-18</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/iOS/" rel="tag">iOS</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <hr>
<h2 id="Barcode"><a href="#Barcode" class="headerlink" title="Barcode"></a>Barcode</h2><p>&#8195;&#8195;”Barcode”（条形码）是一种用于储存和检索数据的图形标识符。它通常由一系列宽度和间隙不同的条和空组成，用于表示数字、字母和其他字符。条形码在商业、物流、库存管理和其他领域广泛应用，以提高数据的追踪和管理效率。</p>
<p>条形码的主要类型包括一维码（1D Barcode）和二维码（2D Barcode）。</p>
<ol>
<li><strong>一维码（1D Barcode）：</strong> 一维码是由一系列宽度和间隙不同的条和空组成的图形，用于表示线性的数据。一维码主要用于表示数字、字母和其他特定字符。常见的一维码类型包括Code 39、Code 128、UPC、EAN等。</li>
<li><strong>二维码（2D Barcode）：</strong> 二维码是由一系列黑白块组成的图形，可以在水平和垂直方向上表示数据。相比一维码，二维码可以存储更多的信息，包括文本、链接、图像等。常见的二维码类型包括QR Code、Data Matrix、Aztec Code等。</li>
</ol>
<p>&#8195;&#8195;生活中我们提到“条形码”，其实多数场景指的是一维的。之前接入的厂商问我最常用的条形码是哪种，确实问着我了，哈哈哈。</p>
<p>&#8195;&#8195;条形码是一种用于储存和获取信息的编码方式，不同的应用场景和需求导致了多种类型的条形码的产生。以下是一些常见的条形码类型：</p>
<ol>
<li><strong>UPC (Universal Product Code):</strong> 通用产品代码，主要用于零售业，尤其是在北美地区。UPC 通常用于标识商品。</li>
<li><strong>EAN (International Article Number):</strong> 国际商品编码，与UPC类似，也用于商品标识。EAN 通常是 13 位的数字码，当然也有 8 位的。</li>
<li><strong>Code 39:</strong> 一种常见的线性条形码，支持字母、数字和一些特殊字符。常用于工业、物流和标签打印。</li>
<li><strong>Code 128:</strong> 另一种常见的线性条形码，具有更高的数据密度和字符集支持。广泛用于物流和制造业。</li>
<li><strong>QR Code (Quick Response Code):</strong> 二维码，可以存储更多的信息，包括文本、链接、图像等。常见于广告、移动支付、票务等领域。</li>
<li><strong>Aztec Code：</strong>另一种二维码，阿兹特克码，常用于需要高密度数据存储的场景，例如票务、身份证、支付系统等。</li>
<li><strong>Data Matrix:</strong> 另一种二维码，可以存储大量数据，特别适用于小空间。常用于电子元件、制造业和医疗设备。</li>
<li><strong>PDF417:</strong> 一种堆叠式的二维码，可以存储大量信息。通常用于身份证、驾驶证等证件。</li>
</ol>
<p>&#8195;&#8195;这只是一小部分常见的条形码类型，实际上还有许多其他类型，每种都有其特定的用途和应用领域。选择条形码类型通常取决于需要存储的信息量、可读性要求以及应用的具体要求。</p>
<h2 id="QR-Scanner"><a href="#QR-Scanner" class="headerlink" title="QR Scanner"></a>QR Scanner</h2><p>&#8195;&#8195;往常扫码的需求不多，多数场景仅需要扫描二维码，所以直接通过 <code>AVFoundation</code> 来扫描并识别条码，<code>AVMetadataObject.ObjectType</code> 支持的条码类型包含了大部分常见的类型:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AVMetadataObjectTypeUPCECode</span></span><br><span class="line"><span class="type">AVMetadataObjectTypeCode39Code</span></span><br><span class="line"><span class="type">AVMetadataObjectTypeCode39Mod43Code</span></span><br><span class="line"><span class="type">AVMetadataObjectTypeEAN13Code</span></span><br><span class="line"><span class="type">AVMetadataObjectTypeEAN8Code</span></span><br><span class="line"><span class="type">AVMetadataObjectTypeCode93Code</span></span><br><span class="line"><span class="type">AVMetadataObjectTypeCode128Code</span></span><br><span class="line"><span class="type">AVMetadataObjectTypePDF417Code</span></span><br><span class="line"><span class="type">AVMetadataObjectTypeQRCode</span></span><br><span class="line"><span class="type">AVMetadataObjectTypeAztecCode</span></span><br><span class="line"><span class="type">AVMetadataObjectTypeInterleaved2of5Code</span></span><br><span class="line"><span class="type">AVMetadataObjectTypeITF14Code</span></span><br><span class="line"><span class="type">AVMetadataObjectTypeDataMatrixCode</span></span><br></pre></td></tr></table></figure>

<p>&#8195;&#8195;对于识别图片中的条形码，这个库使用的是</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CIDetector</span>(ofType: <span class="type">CIDetectorTypeQRCode</span>, context: context)</span><br></pre></td></tr></table></figure>

<p>，关于条形码支持的类型也很直白 - CIDetectorTypeQRCode，只支持二维码…所以想从照片中识别一维码，要换个思路了。</p>
<h2 id="Vision"><a href="#Vision" class="headerlink" title="Vision"></a>Vision</h2><p>&#8195;&#8195;苹果从 ios11.0 开始支持 FaceID，相应推出了 Vision 框架。Vision 是一个用于图像和视觉处理的框架，它提供了一系列的工具和功能，涵盖了多个领域，包括面部识别、文本识别、物体追踪等。</p>
<p>以下是一些 Vision 框架的主要功能：</p>
<ol>
<li><strong>面部识别（Face Recognition）：</strong> Vision 框架可以检测图像中的面部，识别面部的特征，例如眼睛、嘴巴、鼻子等。它还能够进行面部追踪，跟踪在视频中移动的面部。</li>
<li><strong>文本识别（Text Recognition）：</strong> Vision 框架支持对图像中的文本进行识别。这对于从照片或摄像头中捕捉到的文本进行实时处理很有用。</li>
<li><strong>物体追踪（Object Tracking）：</strong> Vision 框架可以追踪图像或视频中的物体，使得你能够跟踪物体的位置随时间的变化。</li>
<li><strong>图像分类和识别（Image Classification）：</strong> Vision 框架支持通过机器学习模型对图像进行分类和识别。你可以使用预训练的模型，也可以集成自己训练的模型。</li>
<li><strong>图像分割（Image Segmentation）：</strong> Vision 框架允许对图像进行分割，将图像中的不同区域标记为不同的对象。</li>
</ol>
<p>讲真，之前在工作中一个也没用上…所以不再敢称自己为开发者了，iOSer 秒变 Ioser，懂得都懂。🤧</p>
<p>言归正传：</p>
<p>&#8195;&#8195;翻一翻框架包含 detect 字样的 API，很多 “Vision/VNDetect–”，有一个 <strong>VNDetectBarcodesRequest</strong> 看上去非常符合我们的需求。发送图像识别请求，需要通过 <strong>VNImageRequestHandler</strong>，这个类型用于处理单个图像上的 Vision 请求。</p>
<h3 id="VNImageRequestHandler"><a href="#VNImageRequestHandler" class="headerlink" title="VNImageRequestHandler"></a>VNImageRequestHandler</h3><p>&#8195;&#8195;尝试了几个 API、在 OC 中不小心造了个僵尸、抓僵尸抓了半天😈，最终选择用 CVPixelBuffer 来创建请求，其他使用 CGImage 的方式占用的内存似乎比较高？，因为我拿一张单反相机拍的略大艺术照做测试，挂掉了…</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">detectBarcodeFromImg</span>(<span class="keyword">_</span> <span class="params">oriImg</span>: <span class="type">UIImage</span>, <span class="keyword">_</span> <span class="params">completion</span>: <span class="keyword">@escaping</span> (<span class="type">Barcode</span>) -&gt; <span class="type">Void</span>)</span> &#123;</span><br><span class="line">		<span class="operator">...</span></span><br><span class="line">    <span class="type">DispatchQueue</span>.<span class="keyword">init</span>(label: <span class="string">&quot;com.yydetector.session.queue&quot;</span>).async &#123; [<span class="keyword">self</span>] <span class="keyword">in</span>                                                                     </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> buffer <span class="operator">=</span> pixelBuffer(from: oriImg<span class="operator">!</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Image type not support!&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">                                                                     </span><br><span class="line">        <span class="keyword">let</span> requestHandler <span class="operator">=</span> <span class="type">VNImageRequestHandler</span>.<span class="keyword">init</span>(cvPixelBuffer: buffer)</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> detectRequest <span class="operator">=</span> <span class="type">VNDetectBarcodesRequest</span> &#123; [<span class="keyword">self</span>] request, error <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> error <span class="operator">=</span> error &#123;</span><br><span class="line">                    <span class="built_in">print</span>(error.localizedDescription)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> request.results<span class="operator">!</span>.isEmpty &#123;</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;No result of request!&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> <span class="keyword">case</span> <span class="keyword">let</span> barcode <span class="keyword">as</span> <span class="type">VNBarcodeObservation</span> <span class="keyword">in</span> request.results<span class="operator">!</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> barcode.payloadStringValue <span class="operator">!=</span> <span class="literal">nil</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> formatter <span class="operator">=</span> printBarcode(barcode)</span><br><span class="line">                        <span class="built_in">print</span>(formatter)</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;No payload string value!&quot;</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> requestHandler.perform([detectRequest])</span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">          	<span class="built_in">print</span>(error.localizedDescription)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#8195;&#8195;识别到的结果会通过 VNBarcodeObservation 类型来返回，里面的属性非常详细，打印了几个，其他的不在这里罗列了：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">✅</span> <span class="type">VNBarcodeObservation</span>:</span><br><span class="line"> 〽️value <span class="operator">=</span> http:<span class="comment">//weixin.qq.com/r/cHVyahfEvErDrVMJ9yBi, </span></span><br><span class="line"> 〽️type <span class="operator">=</span> <span class="type">VNBarcodeSymbologyQR</span>, </span><br><span class="line"> 〽️confidence <span class="operator">=</span> <span class="number">1.0</span>, </span><br><span class="line"> 〽️boundingBox <span class="operator">=</span> </span><br><span class="line">	 x <span class="operator">=</span> <span class="number">0.267</span>, </span><br><span class="line">	 y <span class="operator">=</span> <span class="number">0.407</span>, </span><br><span class="line">	 w <span class="operator">=</span> <span class="number">0.130</span>, </span><br><span class="line">	 h <span class="operator">=</span> <span class="number">0.060</span>, </span><br><span class="line"> 〽️desc : </span><br><span class="line">	 symbolVersion <span class="operator">=</span> <span class="number">3</span>, </span><br><span class="line">	 maskPattern <span class="operator">=</span> <span class="number">2</span>, </span><br><span class="line">	 errorCorrectionLevel <span class="operator">=</span> <span class="number">76</span>, </span><br><span class="line">	 errorCorrectedPayload <span class="operator">=</span>  </span><br></pre></td></tr></table></figure>

<p>payloadStringValue(value) - 条码内容；<br>symbology(type) - 条码类型；<br>confidence - 表明了识别这个码的信心，0.6~1 貌似比较多，太低的话框架也就不识别了、或者不建议使用；<br>boundingBox - 是条形码的识别区域；<br>errorCorrectionLevel - 纠错级别；</p>
<h3 id="条形码的背景色"><a href="#条形码的背景色" class="headerlink" title="条形码的背景色"></a>条形码的背景色</h3><p>&#8195;&#8195;原本以为写到这里作为一个补充功能也算是够用了，直到测试拿出了下面这张图：用在线工具随便生成了一个条形码、保存到手机相册、识别，扫码可以扫出来，但识别不出来[Emm][Emm]…</p>
<center>
    <div style="display:inline-block;"><img src="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_4.jpg" class width="300"></div>
</center>

<p>&#8195;&#8195;码看着是个正经码，但是为什么识别不出来呢？左右两侧的边缘处贴边了？PC 上截图再保存，也是可以识别出来的，那估计就是贴边导致的…说到这里，你可以随手拿起一个身边有条码的物品，不论物品的外包装是什么颜色的，条码一般都会单独有一个白色（浅色）的、码的四周有空白的背景区域，目的就是为了扫码的时候可以识别的快一点。看到有个外国网友提问：“自己在帮一个彩色水笔的公司做扫码功能，他们水笔的外包装是偏暗黑色的、水笔的条形码是…五颜六色的彩色，结账扫码时总是很慢，如何提到扫码的效率？”咱就是说，换个外包装呢😶…</p>
<p>&#8195;&#8195;那影响扫码效率的因素都有哪些，除了码的形状(复杂度)，是不是还有背景色或者说对比度？本来想尝试一下“抠图”，把这个贴边的条形码扣到一个白色背景上，结果算法没整明白，抠出来一个莫名其妙的效果：</p>
<center>
    <div style="display:inline-block;"><img src="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_6.PNG" class width="200"></div>
    <div style="display:inline-block;margin-left:10px;"><img src="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_7.PNG" class width="200"></div>
</center>

<p>so…放弃。抠它干嘛呢，直接画到一个白色的背景图片上呢？为了避免再出现这种贴边的图、镂空的图，先是画了一个比原图的宽高都大 10 的白色图片，然后把原图放到白色背景板的中心，再识别，就成功了。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">imageFromColor</span>(<span class="keyword">_</span> <span class="params">color</span>: <span class="type">UIColor</span>, <span class="params">size</span>: <span class="type">CGSize</span>)</span> -&gt; <span class="type">UIImage</span>! &#123;</span><br><span class="line">    <span class="keyword">let</span> rect <span class="operator">=</span> <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">0</span>, width: size.width <span class="operator">+</span> <span class="number">10</span>, height: size.height <span class="operator">+</span> <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="type">UIGraphicsBeginImageContext</span>(rect.size)</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> context <span class="operator">=</span> <span class="type">UIGraphicsGetCurrentContext</span>() <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">UIImage</span>(named: <span class="string">&quot;scan_bg&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    context.setFillColor(color.cgColor)</span><br><span class="line">    context.fill(rect)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> image <span class="operator">=</span> <span class="type">UIGraphicsGetImageFromCurrentImageContext</span>()</span><br><span class="line">    <span class="type">UIGraphicsEndImageContext</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> image</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">drawImage</span>(<span class="keyword">_</span> <span class="params">oriImg</span>: <span class="type">CGImage</span>, <span class="params">toCenter</span> <span class="params">bgImg</span>: <span class="type">CGImage</span>)</span> -&gt; <span class="type">UIImage</span>? &#123;</span><br><span class="line">    <span class="keyword">let</span> targetSize <span class="operator">=</span> <span class="type">CGSize</span>(width: <span class="type">CGFloat</span>(bgImg.width), height: <span class="type">CGFloat</span>(bgImg.height))</span><br><span class="line"></span><br><span class="line">    <span class="type">UIGraphicsBeginImageContextWithOptions</span>(targetSize, <span class="literal">false</span>, <span class="number">0.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> bottomImage <span class="operator">=</span> <span class="type">UIImage</span>(cgImage: bgImg)</span><br><span class="line">    bottomImage.draw(in: <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">0</span>, width: targetSize.width, height: targetSize.height))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> scaledSize <span class="operator">=</span> <span class="type">CGSize</span>(width: <span class="type">CGFloat</span>(oriImg.width), height: <span class="type">CGFloat</span>(oriImg.height))</span><br><span class="line">    <span class="keyword">let</span> destinationRect <span class="operator">=</span> <span class="type">CGRect</span>(</span><br><span class="line">        x: (targetSize.width <span class="operator">-</span> scaledSize.width) <span class="operator">/</span> <span class="number">2</span>,</span><br><span class="line">        y: (targetSize.height <span class="operator">-</span> scaledSize.height) <span class="operator">/</span> <span class="number">2</span>,</span><br><span class="line">        width: scaledSize.width,</span><br><span class="line">        height: scaledSize.height</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> centeredImage <span class="operator">=</span> <span class="type">UIImage</span>(cgImage: oriImg)</span><br><span class="line">    centeredImage.draw(in: destinationRect)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> finalImage <span class="operator">=</span> <span class="type">UIGraphicsGetImageFromCurrentImageContext</span>()</span><br><span class="line">    <span class="type">UIGraphicsEndImageContext</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> finalImage</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">✅</span> <span class="type">VNBarcodeObservation</span>:</span><br><span class="line"> 〽️value <span class="operator">=</span> 304329G00015157, </span><br><span class="line"> 〽️type <span class="operator">=</span> <span class="type">VNBarcodeSymbologyCode128</span>, </span><br><span class="line"> 〽️confidence <span class="operator">=</span> <span class="number">0.8</span>, </span><br><span class="line"> 〽️boundingBox <span class="operator">=</span> </span><br><span class="line">	 x <span class="operator">=</span> <span class="number">0.015</span>, </span><br><span class="line">	 y <span class="operator">=</span> <span class="number">0.116</span>, </span><br><span class="line">	 w <span class="operator">=</span> <span class="number">0.970</span>, </span><br><span class="line">	 h <span class="operator">=</span> <span class="number">0.024</span>, </span><br><span class="line"> 〽️desc :  </span><br></pre></td></tr></table></figure>

<h3 id="律动的小箭头"><a href="#律动的小箭头" class="headerlink" title="律动的小箭头"></a>律动的小箭头</h3><p>&#8195;&#8195;当看到 Vision 返回了 boundingBox 时，又想到了一个需求：如果图片上有多个条码时，在每个可识别的区域加一个小箭头🔜，让用户自己选择使用哪个结果。效果如下：</p>
<center>
    <div style="display:inline-block;"><img src="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_1.jpg" class width="200"></div>
    <div style="display:inline-block;margin-left:10px;"><img src="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_2.jpg" class width="200"></div>
  <div style="display:inline-block;margin-left:10px;"><img src="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_3.jpg" class width="200"></div>
</center>
思路是：

<ol>
<li>识别到每个条码的 <strong>boundingBox</strong>，注意坐标系是 (0,1) 坐标，先简称为 CI 坐标系吧；</li>
<li>图片在 ImageView 上的预览模式是 UIView.ContentMode = <strong>scaleAspectFit</strong>，想准确放置小箭头，那需要先拿到图片基于 ImageView 的区域，这里称为 UI 坐标系：（此片段来自 ChatGPT，哈哈。讲真，代码规范比我们某些同志的代码都干净）</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIImageView</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">renderingRectForImage</span>()</span> -&gt; <span class="type">CGRect</span>? &#123;</span><br><span class="line">      <span class="operator">...</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> .scaleAspectFit:</span><br><span class="line">            <span class="keyword">let</span> scale <span class="operator">=</span> <span class="built_in">min</span>(imageViewBounds.width <span class="operator">/</span> imageSize.width, imageViewBounds.height <span class="operator">/</span> imageSize.height)</span><br><span class="line">            <span class="keyword">let</span> width <span class="operator">=</span> imageSize.width <span class="operator">*</span> scale</span><br><span class="line">            <span class="keyword">let</span> height <span class="operator">=</span> imageSize.height <span class="operator">*</span> scale</span><br><span class="line">            renderingRect.size <span class="operator">=</span> <span class="type">CGSize</span>(width: width, height: height)</span><br><span class="line">            renderingRect.origin.x <span class="operator">=</span> (imageViewBounds.width <span class="operator">-</span> width) <span class="operator">/</span> <span class="number">2</span></span><br><span class="line">            renderingRect.origin.y <span class="operator">=</span> (imageViewBounds.height <span class="operator">-</span> height) <span class="operator">/</span> <span class="number">2</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> .scaleAspectFill:</span><br><span class="line">            <span class="keyword">let</span> scale <span class="operator">=</span> <span class="built_in">max</span>(imageViewBounds.width <span class="operator">/</span> imageSize.width, imageViewBounds.height <span class="operator">/</span> imageSize.height)</span><br><span class="line">            <span class="keyword">let</span> width <span class="operator">=</span> imageSize.width <span class="operator">*</span> scale</span><br><span class="line">            <span class="keyword">let</span> height <span class="operator">=</span> imageSize.height <span class="operator">*</span> scale</span><br><span class="line">            renderingRect.size <span class="operator">=</span> <span class="type">CGSize</span>(width: width, height: height)</span><br><span class="line">            renderingRect.origin.x <span class="operator">=</span> (imageViewBounds.width <span class="operator">-</span> width) <span class="operator">/</span> <span class="number">2</span></span><br><span class="line">            renderingRect.origin.y <span class="operator">=</span> (imageViewBounds.height <span class="operator">-</span> height) <span class="operator">/</span> <span class="number">2</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> .center:</span><br><span class="line">            renderingRect.size <span class="operator">=</span> imageSize</span><br><span class="line">            renderingRect.origin.x <span class="operator">=</span> (imageViewBounds.width <span class="operator">-</span> imageSize.width) <span class="operator">/</span> <span class="number">2</span></span><br><span class="line">            renderingRect.origin.y <span class="operator">=</span> (imageViewBounds.height <span class="operator">-</span> imageSize.height) <span class="operator">/</span> <span class="number">2</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment">// 其他 contentMode 类型可以根据需要进行扩展</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line"> 	 <span class="operator">...</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> renderingRect</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>得到图片区域以后，把基于 CI 坐标的 boundingBox 转换为 UI 坐标，用来添加 view：</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">convertCIBoundingRectToUIRect</span>(<span class="keyword">_</span> <span class="params">ci</span>: <span class="type">CGRect</span>)</span> -&gt; <span class="type">CGRect</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> renderingRect <span class="operator">=</span> imgV.renderingRectForImage()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> w <span class="operator">=</span> ci.size.width <span class="operator">*</span> renderingRect<span class="operator">!</span>.size.width</span><br><span class="line">    <span class="keyword">let</span> h <span class="operator">=</span> ci.size.height <span class="operator">*</span> renderingRect<span class="operator">!</span>.size.height</span><br><span class="line">    <span class="keyword">let</span> x <span class="operator">=</span> ci.origin.x <span class="operator">*</span> renderingRect<span class="operator">!</span>.size.width <span class="operator">+</span> renderingRect<span class="operator">!</span>.origin.x</span><br><span class="line">    <span class="keyword">let</span> y <span class="operator">=</span> ci.origin.y <span class="operator">*</span> renderingRect<span class="operator">!</span>.size.height <span class="operator">+</span> renderingRect<span class="operator">!</span>.origin.y</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="type">CGRectMake</span>(x, y, w, h)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>基于转换后的坐标创建抖动的绿色小箭头，告诉用户“点我<del>点我</del>”。到这一步基本上已经达到上图的目的了。</li>
</ol>
<p>But…<br>But…<br>But…</p>
<p>&#8195;&#8195;上面的小箭头其实是经过一次“变态”转换之后的效果。用过 CI 坐标的都知道，在 CoreImage 中或者说读到内存中的图片，坐标系的原点和图片方向是有关系的，并不是单纯和 UI 坐标上下反过来的关系。正常情况下图片的方向是 <strong>CGImagePropertyOrientation.up</strong>，想模拟其他方向可以把手机横着或者倒过来拍照试试，还用上面的多条码图片举例，按照我们 1-4 步骤出来的效果其实是这样的;</p>
<center>
    <div style="display:inline-block;"><img src="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_8.PNG" class width="200"></div>
</center>

<p>很明显，识别区域都是有的，但坐标方向是不准确的。可以看一下 <strong>CGImagePropertyOrientation</strong> 的注解，对每个方向的原点位置都做了说明：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@frozen</span> <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">CGImagePropertyOrientation</span> : <span class="title">UInt32</span>, @<span class="title">unchecked</span> <span class="title">Sendable</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">case</span> up <span class="operator">=</span> <span class="number">1</span> <span class="comment">// 0th row at top,    0th column on left   - default orientation</span></span><br><span class="line"><span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下一步，</p>
<ol start="5">
<li>需要把图片方向“指定”一下，坐标转换时加一次“变态”转换 - <strong>CGAffineTransform</strong>：</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">detectBarcodeFromImg</span>(<span class="keyword">_</span> <span class="params">oriImg</span>: <span class="type">UIImage</span>, <span class="keyword">_</span> <span class="params">completion</span>: <span class="keyword">@escaping</span> (<span class="type">Barcode</span>) -&gt; <span class="type">Void</span>)</span> &#123;</span><br><span class="line">		<span class="operator">...</span></span><br><span class="line">    <span class="type">DispatchQueue</span>.<span class="keyword">init</span>(label: <span class="string">&quot;com.yydetector.session.queue&quot;</span>).async &#123; [<span class="keyword">self</span>] <span class="keyword">in</span>                                                                     </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> buffer <span class="operator">=</span> pixelBuffer(from: oriImg<span class="operator">!</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Image type not support!&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">                                                                     </span><br><span class="line">        <span class="keyword">let</span> tempOrientation <span class="operator">=</span> getCGImagePropertyOrientation(from: oriImg.imageOrientation)</span><br><span class="line">        <span class="keyword">let</span> requestHandler <span class="operator">=</span> <span class="type">VNImageRequestHandler</span>.<span class="keyword">init</span>(cvPixelBuffer: buffer, orientation: tempOrientation)</span><br><span class="line">        <span class="operator">...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">convertCIBoundingRectToUIRect</span>(<span class="keyword">_</span> <span class="params">cii</span>: <span class="type">CGRect</span>)</span> -&gt; <span class="type">CGRect</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> renderingRect <span class="operator">=</span> imgV.renderingRectForImage()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> ci <span class="operator">=</span> cii.applying(getCGAffineTransform(from: orientation<span class="operator">!</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> w <span class="operator">=</span> ci.size.width <span class="operator">*</span> renderingRect<span class="operator">!</span>.size.width</span><br><span class="line">    <span class="keyword">let</span> h <span class="operator">=</span> ci.size.height <span class="operator">*</span> renderingRect<span class="operator">!</span>.size.height</span><br><span class="line">    <span class="keyword">let</span> x <span class="operator">=</span> ci.origin.x <span class="operator">*</span> renderingRect<span class="operator">!</span>.size.width <span class="operator">+</span> renderingRect<span class="operator">!</span>.origin.x</span><br><span class="line">    <span class="keyword">let</span> y <span class="operator">=</span> ci.origin.y <span class="operator">*</span> renderingRect<span class="operator">!</span>.size.height <span class="operator">+</span> renderingRect<span class="operator">!</span>.origin.y</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="type">CGRectMake</span>(x, y, w, h)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getCGAffineTransform</span>(<span class="params">from</span> <span class="params">orientation</span>: <span class="type">CGImagePropertyOrientation</span>)</span> -&gt; <span class="type">CGAffineTransform</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> orientation &#123;</span><br><span class="line">    <span class="keyword">case</span> .up, .down:</span><br><span class="line">        <span class="keyword">return</span> <span class="type">CGAffineTransform</span>(scaleX: <span class="number">1</span>, y: <span class="number">1</span>).translatedBy(x: <span class="number">0</span>, y: <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="type">CGAffineTransform</span>(scaleX: <span class="operator">-</span><span class="number">1</span>, y: <span class="operator">-</span><span class="number">1</span>).translatedBy(x: <span class="operator">-</span><span class="number">1</span>, y: <span class="operator">-</span><span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<center>
    <div style="display:inline-block;"><img src="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_9.PNG" class width="200"></div>
</center>

<p>到这里应该可以了吧？</p>
<p>But…<br>But…<br>But…</p>
<h3 id="我的小情怀"><a href="#我的小情怀" class="headerlink" title="我的小情怀"></a>我的小情怀</h3><p>&#8195;&#8195;我个人对某些机型或者系统有自己奇奇怪怪的情怀，很少以旧换新。例如有台 iPhone 5s 是第一代指纹识别的 HOME 键，让它的系统一直停留在了 ios9；又例如有台 iPhone 12 边框是方的所以喜欢，让它停在了 ios15.4，也因为莫名其妙觉得它比较省电。这不是重点，重点是同样的 API、同样的律动小箭头、同样的一个贴边儿条形码，在这台 iPhone 12 上，识别出来是这样的，具体识别出来了几个，我也没数🤷‍♀️：</p>
<center>
    <div style="display:inline-block;"><img src="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_5.jpg" class width="200"></div>
</center>

<p>…<br>…</p>
<center>
    <div style="display:inline-block;"><img src="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_10.jpg" class width="80"></div>
  <div style="display:inline-block;"><img src="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_10.jpg" class width="80"></div>
  <div style="display:inline-block;"><img src="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_10.jpg" class width="80"></div>
  <div style="display:inline-block;"><img src="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_10.jpg" class width="80"></div>
  <div style="display:inline-block;"><img src="https://yyblog-images-1258406742.cos.ap-beijing.myqcloud.com/vision_10.jpg" class width="80"></div>
</center>




<p>&#8195;&#8195;哪个坏人总说客户端简单的？打你哦。</p>
<p>&#8195;&#8195;正经人谁做客户端开发啊。</p>
<p>&#8195;&#8195;关机，保命，再见。</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>最后一句，<a target="_blank" rel="noopener" href="https://github.com/ATommyGirl/Vision.git">代码在这里</a>，需要自取。</p>
<hr>

  </div>
</article>


    
<div class="gitalk" id="gitalk-container"></div>
<link rel="stylesheet" href="/gDark.css" media="screen" type="text/css"> 

<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>


<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>

<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: 'c0fd3fecc668416852dc',
    clientSecret: '5f849bbb22f9233b3fe19627c9eb28be39b721d1',
    repo: 'YYBlogGiTalk',
    owner: 'ATommyGirl',
    admin: ['ATommyGirl'],
    // id: location.pathname,      // Ensure uniqueness and length less than 50
    id: md5(location.pathname),
    distractionFreeMode: false,  // Facebook-like distraction free mode
    pagerDirection: 'last',
    proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
  })

  gitalk.render('gitalk-container')
</script>


    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>加载评论需要在浏览器启用 JavaScript 脚本支持。</noscript>
        </div>
    </div>
    



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">归档</a></li>
         
          <li><a href="/tags">标签</a></li>
         
          <li><a href="/about">关于</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Barcode"><span class="toc-number">1.</span> <span class="toc-text">Barcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#QR-Scanner"><span class="toc-number">2.</span> <span class="toc-text">QR Scanner</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vision"><span class="toc-number">3.</span> <span class="toc-text">Vision</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#VNImageRequestHandler"><span class="toc-number">3.1.</span> <span class="toc-text">VNImageRequestHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E5%BD%A2%E7%A0%81%E7%9A%84%E8%83%8C%E6%99%AF%E8%89%B2"><span class="toc-number">3.2.</span> <span class="toc-text">条形码的背景色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%8B%E5%8A%A8%E7%9A%84%E5%B0%8F%E7%AE%AD%E5%A4%B4"><span class="toc-number">3.3.</span> <span class="toc-text">律动的小箭头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%91%E7%9A%84%E5%B0%8F%E6%83%85%E6%80%80"><span class="toc-number">3.4.</span> <span class="toc-text">我的小情怀</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">代码</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://tiantian.fyi/2023/12/18/Vision/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://tiantian.fyi/2023/12/18/Vision/&text=一码归一码"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://tiantian.fyi/2023/12/18/Vision/&title=一码归一码"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://tiantian.fyi/2023/12/18/Vision/&is_video=false&description=一码归一码"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=一码归一码&body=Check out this article: https://tiantian.fyi/2023/12/18/Vision/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://tiantian.fyi/2023/12/18/Vision/&title=一码归一码"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://tiantian.fyi/2023/12/18/Vision/&title=一码归一码"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://tiantian.fyi/2023/12/18/Vision/&title=一码归一码"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://tiantian.fyi/2023/12/18/Vision/&title=一码归一码"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://tiantian.fyi/2023/12/18/Vision/&name=一码归一码&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://tiantian.fyi/2023/12/18/Vision/&t=一码归一码"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">归档</a></li>
         
          <li><a href="/tags">标签</a></li>
         
          <li><a href="/about">关于</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </nav> 
  </div>
  <div class="footer-right">
      YYLittleCat
      Copyright &copy;
      
      
      2015-2023
  </div>
  <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn">津ICP备2021005176号</a>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"left","width":300,"height":600,"vOffset":-100,"hOffset":50},"mobile":{"show":false},"log":false});</script></body>
</html>
