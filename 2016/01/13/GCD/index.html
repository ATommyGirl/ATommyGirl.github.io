<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="è½¬è½½è‡ª æˆ´é“­è€å¸ˆ  æ–‡ä¸­è¾ƒè¯¦ç»†ä»‹ç»GCDé˜Ÿåˆ—ï¼Œå„ç§GCDä½¿ç”¨æ–¹æ³•ï¼Œå®ä¾‹å¦‚ä½•ä½¿ç”¨Dispatch Sourceç›‘å¬ç³»ç»Ÿåº•å±‚å¯¹è±¡ï¼Œåˆ†æä¸åŒé”çš„æ€§èƒ½å¯¹æ¯”ï¼Œå®ä¾‹GCDæ­»é”æƒ…å†µã€‚  æ–‡ä¸­çš„Demoåœ¨è¿™é‡Œ Demo å¯¹ç€æ–‡ç« è¯•ç€æ¥è°ƒdemoä½“ä¼šæ›´æ·±å“¦ï¼Œç»†ç»†åš¼æ¶ˆåŒ–å¥½ğŸ¤“">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)">
<meta property="og:url" content="https://tommygirl.cn/2016/01/13/GCD/index.html">
<meta property="og:site_name" content="èåœç”°">
<meta property="og:description" content="è½¬è½½è‡ª æˆ´é“­è€å¸ˆ  æ–‡ä¸­è¾ƒè¯¦ç»†ä»‹ç»GCDé˜Ÿåˆ—ï¼Œå„ç§GCDä½¿ç”¨æ–¹æ³•ï¼Œå®ä¾‹å¦‚ä½•ä½¿ç”¨Dispatch Sourceç›‘å¬ç³»ç»Ÿåº•å±‚å¯¹è±¡ï¼Œåˆ†æä¸åŒé”çš„æ€§èƒ½å¯¹æ¯”ï¼Œå®ä¾‹GCDæ­»é”æƒ…å†µã€‚  æ–‡ä¸­çš„Demoåœ¨è¿™é‡Œ Demo å¯¹ç€æ–‡ç« è¯•ç€æ¥è°ƒdemoä½“ä¼šæ›´æ·±å“¦ï¼Œç»†ç»†åš¼æ¶ˆåŒ–å¥½ğŸ¤“">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2016-01-13T14:20:34.000Z">
<meta property="article:modified_time" content="2016-01-13T14:20:34.000Z">
<meta property="article:author" content="YYLittleCat">
<meta property="article:tag" content="iOS">
<meta property="article:tag" content="è½¬è½½">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/mini-icon.svg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.0.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" "Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">å½’æ¡£</a></li>
         
          <li><a href="/tags">æ ‡ç­¾</a></li>
         
          <li><a href="/about">å…³äº</a></li>
         
          <li><a href="/search/">æœç´¢</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="ä¸Šä¸€ç¯‡ " href="/2016/07/01/CentOS%20%E5%B8%B8%E7%94%A8%E7%9A%84%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="ä¸‹ä¸€ç¯‡ " href="/2015/08/02/HTTP%20%E7%9A%84%E4%B8%80%E7%82%B9%E5%84%BF%E5%B0%8F%E7%9F%A5%E8%AF%86/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="è¿”å›é¡¶éƒ¨ " href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="åˆ†äº«æ–‡ç«  " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">ä¸Šä¸€ç¯‡</span>
      <span id="i-next" class="info" style="display:none;">ä¸‹ä¸€ç¯‡</span>
      <span id="i-top" class="info" style="display:none;">è¿”å›é¡¶éƒ¨</span>
      <span id="i-share" class="info" style="display:none;">åˆ†äº«æ–‡ç« </span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://tommygirl.cn/2016/01/13/GCD/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://tommygirl.cn/2016/01/13/GCD/&text=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://tommygirl.cn/2016/01/13/GCD/&title=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://tommygirl.cn/2016/01/13/GCD/&is_video=false&description=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)&body=Check out this article: https://tommygirl.cn/2016/01/13/GCD/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://tommygirl.cn/2016/01/13/GCD/&title=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://tommygirl.cn/2016/01/13/GCD/&title=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://tommygirl.cn/2016/01/13/GCD/&title=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://tommygirl.cn/2016/01/13/GCD/&title=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://tommygirl.cn/2016/01/13/GCD/&name=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)&description=&lt;p&gt;è½¬è½½è‡ª &lt;a href=&#34;https://github.com/ming1016&#34;&gt;æˆ´é“­è€å¸ˆ&lt;/a&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;æ–‡ä¸­è¾ƒè¯¦ç»†ä»‹ç»GCDé˜Ÿåˆ—ï¼Œå„ç§GCDä½¿ç”¨æ–¹æ³•ï¼Œå®ä¾‹å¦‚ä½•ä½¿ç”¨Dispatch Sourceç›‘å¬ç³»ç»Ÿåº•å±‚å¯¹è±¡ï¼Œåˆ†æä¸åŒé”çš„æ€§èƒ½å¯¹æ¯”ï¼Œå®ä¾‹GCDæ­»é”æƒ…å†µã€‚ &lt;/p&gt;
&lt;p&gt;æ–‡ä¸­çš„Demoåœ¨è¿™é‡Œ &lt;a href=&#34;https://github.com/ming1016/GCDDemo&#34;&gt;Demo&lt;/a&gt; å¯¹ç€æ–‡ç« è¯•ç€æ¥è°ƒdemoä½“ä¼šæ›´æ·±å“¦ï¼Œç»†ç»†åš¼æ¶ˆåŒ–å¥½ğŸ¤“&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://tommygirl.cn/2016/01/13/GCD/&t=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#GCD%E6%A6%82%E8%A6%81"><span class="toc-number">1.</span> <span class="toc-text">GCDæ¦‚è¦</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">åŸºæœ¬æ¦‚å¿µ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E3%80%81-%E7%B3%BB%E7%BB%9F%E6%A0%87%E5%87%86%E4%B8%A4%E4%B8%AA%E9%98%9F%E5%88%97"><span class="toc-number">1.1.1.</span> <span class="toc-text">ä¸€ã€ ç³»ç»Ÿæ ‡å‡†ä¸¤ä¸ªé˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E9%98%9F%E5%88%97"><span class="toc-number">1.1.2.</span> <span class="toc-text">äºŒã€è‡ªå®šä¹‰é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%90%8C%E6%AD%A5%E5%BC%82%E6%AD%A5%E7%BA%BF%E7%A8%8B%E5%88%9B%E5%BB%BA"><span class="toc-number">1.1.3.</span> <span class="toc-text">ä¸‰ã€åŒæ­¥å¼‚æ­¥çº¿ç¨‹åˆ›å»º</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%9F%E5%88%97%EF%BC%88dispatch-queue%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">é˜Ÿåˆ—ï¼ˆdispatch queueï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-number">2.1.</span> <span class="toc-text">åŸºæœ¬ç”¨æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E3%80%81dispatch-get-global-queue"><span class="toc-number">2.1.1.</span> <span class="toc-text">ä¸€ã€dispatch_get_global_queue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E3%80%81dispatch-queue-create"><span class="toc-number">2.1.2.</span> <span class="toc-text">äºŒã€dispatch_queue_create</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%98%9F%E5%88%97%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">2.1.3.</span> <span class="toc-text">ä¸‰ã€é˜Ÿåˆ—ä¼˜å…ˆçº§</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%9F%E5%88%97%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.2.</span> <span class="toc-text">é˜Ÿåˆ—ç±»å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E3%80%815%E7%A7%8D%E9%98%9F%E5%88%97"><span class="toc-number">2.2.1.</span> <span class="toc-text">ä¸€ã€5ç§é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8%E4%BD%95%E7%A7%8D%E9%98%9F%E5%88%97%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.2.2.</span> <span class="toc-text">äºŒã€ä½•æ—¶ä½¿ç”¨ä½•ç§é˜Ÿåˆ—ç±»å‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E3%80%81QoS%E7%AD%89%E7%BA%A7%E5%8F%82%E6%95%B0%E7%9A%84%E5%86%99%E6%B3%95"><span class="toc-number">2.2.3.</span> <span class="toc-text">ä¸‰ã€QoSç­‰çº§å‚æ•°çš„å†™æ³•</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">3.</span> <span class="toc-text">åº”ç”¨åœºæ™¯</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E5%92%8C%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.</span> <span class="toc-text">ç®€å•ä½¿ç”¨å’Œä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E3%80%81dispatch-once%E7%94%A8%E6%B3%95"><span class="toc-number">3.1.1.</span> <span class="toc-text">ä¸€ã€dispatch_onceç”¨æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E3%80%81dispatch-async"><span class="toc-number">3.1.2.</span> <span class="toc-text">äºŒã€dispatch_async</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E3%80%81dispatch-after%E5%BB%B6%E5%90%8E%E6%89%A7%E8%A1%8C"><span class="toc-number">3.1.3.</span> <span class="toc-text">ä¸‰ã€dispatch_afterå»¶åæ‰§è¡Œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B%E3%80%81dispatch-barrier-async%E4%BD%BF%E7%94%A8Barrier-Task%E6%96%B9%E6%B3%95"><span class="toc-number">3.1.4.</span> <span class="toc-text">å››ã€dispatch_barrier_asyncä½¿ç”¨Barrier Taskæ–¹æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%94%E3%80%81dispatch-apply%E8%BF%9B%E8%A1%8C%E5%BF%AB%E9%80%9F%E8%BF%AD%E4%BB%A3"><span class="toc-number">3.1.5.</span> <span class="toc-text">äº”ã€dispatch_applyè¿›è¡Œå¿«é€Ÿè¿­ä»£</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AD%E3%80%81Block%E7%BB%84%E5%90%88Dispatch-groups"><span class="toc-number">3.1.6.</span> <span class="toc-text">å…­ã€Blockç»„åˆDispatch_groups</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%83%E3%80%81Dispatch-Block"><span class="toc-number">3.1.7.</span> <span class="toc-text">ä¸ƒã€Dispatch Block</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#dispatch-block-t-%E5%88%9B%E5%BB%BAblock"><span class="toc-number">3.1.7.1.</span> <span class="toc-text">dispatch_block_t åˆ›å»ºblock</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dispatch-block-wait"><span class="toc-number">3.1.7.2.</span> <span class="toc-text">dispatch_block_wait</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dispatch-block-notify"><span class="toc-number">3.1.7.3.</span> <span class="toc-text">dispatch_block_notify</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dispatch-block-cancel"><span class="toc-number">3.1.7.4.</span> <span class="toc-text">dispatch_block_cancel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8dispatch-block-object%EF%BC%88%E8%B0%83%E5%BA%A6%E5%9D%97%EF%BC%89%E5%9C%A8%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%89%8D%E8%BF%9B%E8%A1%8C%E5%8F%96%E6%B6%88"><span class="toc-number">3.1.7.5.</span> <span class="toc-text">ä½¿ç”¨dispatch block objectï¼ˆè°ƒåº¦å—ï¼‰åœ¨ä»»åŠ¡æ‰§è¡Œå‰è¿›è¡Œå–æ¶ˆ</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AB%E3%80%81Dispatch-IO-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">3.1.8.</span> <span class="toc-text">å…«ã€Dispatch IO æ–‡ä»¶æ“ä½œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B9%9D%E3%80%81Dispatch-Source-%E7%94%A8GCD%E7%9B%91%E8%A7%86%E8%BF%9B%E7%A8%8B"><span class="toc-number">3.1.9.</span> <span class="toc-text">ä¹ã€Dispatch Source ç”¨GCDç›‘è§†è¿›ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%81%E3%80%81Dispatch-Semaphore%E5%92%8C%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.10.</span> <span class="toc-text">åã€Dispatch Semaphoreå’Œçš„ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E9%94%81"><span class="toc-number">3.1.11.</span> <span class="toc-text">åä¸€ã€é”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81dispatch-suspend%E5%92%8Cdispatch-resume%E6%8C%82%E8%B5%B7%E5%92%8C%E6%81%A2%E5%A4%8D%E9%98%9F%E5%88%97"><span class="toc-number">3.1.12.</span> <span class="toc-text">åäºŒã€dispatch_suspendå’Œdispatch_resumeæŒ‚èµ·å’Œæ¢å¤é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%81%E4%B8%89%E3%80%81dispatch-set-context%E5%92%8Cdispatch-get-context"><span class="toc-number">3.1.13.</span> <span class="toc-text">åä¸‰ã€dispatch_set_contextå’Œdispatch_get_context</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GCD%E6%B7%B1%E5%85%A5%E6%93%8D%E4%BD%9C"><span class="toc-number">4.</span> <span class="toc-text">GCDæ·±å…¥æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GCD%E6%AD%BB%E9%94%81"><span class="toc-number">4.1.</span> <span class="toc-text">GCDæ­»é”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GCD%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">GCDå®é™…ä½¿ç”¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#iOS%E7%B3%BB%E7%BB%9F%E7%89%88%E6%9C%AC%E6%96%B0%E7%89%B9%E6%80%A7"><span class="toc-number">5.</span> <span class="toc-text">iOSç³»ç»Ÿç‰ˆæœ¬æ–°ç‰¹æ€§</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#iOS8"><span class="toc-number">5.1.</span> <span class="toc-text">iOS8</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">YYLittleCat</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2016-01-13T14:20:34.000Z" itemprop="datePublished">2016-01-13</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/iOS/" rel="tag">iOS</a>, <a class="tag-link-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">è½¬è½½</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>è½¬è½½è‡ª <a target="_blank" rel="noopener" href="https://github.com/ming1016">æˆ´é“­è€å¸ˆ</a></p>
<hr>
<p>æ–‡ä¸­è¾ƒè¯¦ç»†ä»‹ç»GCDé˜Ÿåˆ—ï¼Œå„ç§GCDä½¿ç”¨æ–¹æ³•ï¼Œå®ä¾‹å¦‚ä½•ä½¿ç”¨Dispatch Sourceç›‘å¬ç³»ç»Ÿåº•å±‚å¯¹è±¡ï¼Œåˆ†æä¸åŒé”çš„æ€§èƒ½å¯¹æ¯”ï¼Œå®ä¾‹GCDæ­»é”æƒ…å†µã€‚ </p>
<p>æ–‡ä¸­çš„Demoåœ¨è¿™é‡Œ <a target="_blank" rel="noopener" href="https://github.com/ming1016/GCDDemo">Demo</a> å¯¹ç€æ–‡ç« è¯•ç€æ¥è°ƒdemoä½“ä¼šæ›´æ·±å“¦ï¼Œç»†ç»†åš¼æ¶ˆåŒ–å¥½ğŸ¤“</p>
<span id="more"></span>



<blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/library/prerelease/ios/documentation/Performance/Reference/GCD_libdispatch_Ref/">Docs</a></p>
<p>GCDå±äºç³»ç»Ÿçº§çš„çº¿ç¨‹ç®¡ç†ï¼Œåœ¨Dispatch queueä¸­æ‰§è¡Œéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ€§èƒ½éå¸¸çš„é«˜ã€‚ GCDè¿™å—å·²ç»å¼€æºï¼Œ<a target="_blank" rel="noopener" href="http://libdispatch.macosforge.org/">åœ°å€</a>ã€‚</p>
<p><strong>GCDä¸­çš„FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰é˜Ÿåˆ—ç§°ä¸ºdispatch queueï¼Œç”¨æ¥ä¿è¯å…ˆè¿›æ¥çš„ä»»åŠ¡å…ˆå¾—åˆ°æ‰§è¡Œã€‚</strong></p>
</blockquote>
<h2 id="GCDæ¦‚è¦"><a href="#GCDæ¦‚è¦" class="headerlink" title="GCDæ¦‚è¦"></a>GCDæ¦‚è¦</h2><ol>
<li><p>å’Œoperation queueä¸€æ ·éƒ½æ˜¯åŸºäºé˜Ÿåˆ—çš„å¹¶å‘ç¼–ç¨‹APIï¼Œä»–ä»¬é€šè¿‡é›†ä¸­ç®¡ç†å¤§å®¶ååŒä½¿ç”¨çš„çº¿ç¨‹æ± ã€‚</p>
</li>
<li><p><strong>å…¬å¼€çš„5ä¸ªä¸åŒé˜Ÿåˆ—</strong>ï¼šè¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­çš„main queueï¼Œ3ä¸ªä¸åŒä¼˜å…ˆçº§çš„åå°é˜Ÿåˆ—ï¼ˆHigh Priority Queueï¼ŒDefault Priority Queueï¼ŒLow Priority Queueï¼‰ï¼Œä»¥åŠä¸€ä¸ªä¼˜å…ˆçº§æ›´ä½çš„åå°é˜Ÿåˆ—Background Priority Queueï¼ˆç”¨äºI/Oï¼‰ã€‚</p>
</li>
<li><p>å¯åˆ›å»ºè‡ªå®šä¹‰é˜Ÿåˆ—ï¼š<strong>ä¸²è¡Œ</strong>æˆ–<strong>å¹¶åˆ—</strong>é˜Ÿåˆ—ã€‚<strong>è‡ªå®šä¹‰ä¸€èˆ¬æ”¾åœ¨Default Priority Queueå’ŒMain Queueé‡Œ</strong>ã€‚</p>
</li>
<li><p>æ“ä½œæ˜¯åœ¨å¤šçº¿ç¨‹ä¸Šè¿˜æ˜¯å•çº¿ç¨‹ä¸»è¦æ˜¯çœ‹é˜Ÿåˆ—çš„ç±»å‹å’Œæ‰§è¡Œæ–¹æ³•ï¼Œ<strong>å¹¶è¡Œé˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œæ‰èƒ½åœ¨å¤šçº¿ç¨‹ï¼Œå¹¶è¡Œé˜Ÿåˆ—åŒæ­¥æ‰§è¡Œå°±åªä¼šåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œäº†</strong>ã€‚</p>
</li>
</ol>
<h3 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><h4 id="ä¸€ã€-ç³»ç»Ÿæ ‡å‡†ä¸¤ä¸ªé˜Ÿåˆ—"><a href="#ä¸€ã€-ç³»ç»Ÿæ ‡å‡†ä¸¤ä¸ªé˜Ÿåˆ—" class="headerlink" title="ä¸€ã€ ç³»ç»Ÿæ ‡å‡†ä¸¤ä¸ªé˜Ÿåˆ—"></a>ä¸€ã€ ç³»ç»Ÿæ ‡å‡†ä¸¤ä¸ªé˜Ÿåˆ—</h4><p>â€‹    //å…¨å±€é˜Ÿåˆ—ï¼Œä¸€ä¸ªå¹¶è¡Œçš„é˜Ÿåˆ—</p>
<p>â€‹    <code>dispatch_get_global_queue</code></p>
<p>â€‹    //ä¸»é˜Ÿåˆ—ï¼Œä¸»çº¿ç¨‹ä¸­çš„å”¯ä¸€é˜Ÿåˆ—ï¼Œä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—</p>
<p>â€‹    <code>dispatch_get_main_queue</code></p>
<h4 id="äºŒã€è‡ªå®šä¹‰é˜Ÿåˆ—"><a href="#äºŒã€è‡ªå®šä¹‰é˜Ÿåˆ—" class="headerlink" title="äºŒã€è‡ªå®šä¹‰é˜Ÿåˆ—"></a>äºŒã€è‡ªå®šä¹‰é˜Ÿåˆ—</h4><p>â€‹    //ä¸²è¡Œé˜Ÿåˆ—</p>
<p>â€‹    <code>dispatch_queue_create(&quot;com.starming.serialqueue&quot;, DISPATCH_QUEUE_SERIAL)</code></p>
<p>â€‹    //å¹¶è¡Œé˜Ÿåˆ—</p>
<p>â€‹    <code>dispatch_queue_create(&quot;com.starming.concurrentqueue&quot;, DISPATCH_QUEUE_CONCURRENT)</code></p>
<h4 id="ä¸‰ã€åŒæ­¥å¼‚æ­¥çº¿ç¨‹åˆ›å»º"><a href="#ä¸‰ã€åŒæ­¥å¼‚æ­¥çº¿ç¨‹åˆ›å»º" class="headerlink" title="ä¸‰ã€åŒæ­¥å¼‚æ­¥çº¿ç¨‹åˆ›å»º"></a>ä¸‰ã€åŒæ­¥å¼‚æ­¥çº¿ç¨‹åˆ›å»º</h4><p>â€‹    //åŒæ­¥çº¿ç¨‹</p>
<p>â€‹    <code>dispatch_sync(..., ^(block))</code></p>
<p>â€‹    //å¼‚æ­¥çº¿ç¨‹</p>
<p>â€‹    <code>dispatch_async(..., ^(block))</code></p>
<h2 id="é˜Ÿåˆ—ï¼ˆdispatch-queueï¼‰"><a href="#é˜Ÿåˆ—ï¼ˆdispatch-queueï¼‰" class="headerlink" title="é˜Ÿåˆ—ï¼ˆdispatch queueï¼‰"></a>é˜Ÿåˆ—ï¼ˆdispatch queueï¼‰</h2><h3 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h3><h4 id="ä¸€ã€dispatch-get-global-queue"><a href="#ä¸€ã€dispatch-get-global-queue" class="headerlink" title="ä¸€ã€dispatch_get_global_queue"></a>ä¸€ã€dispatch_get_global_queue</h4><ol>
<li>Serialï¼šåˆå«private dispatch queuesï¼ŒåŒæ—¶åªæ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚Serial queueå¸¸ç”¨äºåŒæ­¥è®¿é—®ç‰¹å®šçš„èµ„æºæˆ–æ•°æ®ã€‚ å½“ä½ åˆ›å»ºå¤šä¸ªSerial queueæ—¶ï¼Œè™½ç„¶å„è‡ªæ˜¯åŒæ­¥ï¼Œä½†serial queueä¹‹é—´æ˜¯å¹¶å‘æ‰§è¡Œã€‚ </li>
<li>Main dispatch queueï¼š<strong>å…¨å±€å¯ç”¨çš„serial queue</strong>ï¼Œåœ¨åº”ç”¨ç¨‹åº<strong>ä¸»çº¿ç¨‹ä¸Š</strong>æ‰§è¡Œä»»åŠ¡ã€‚</li>
<li>Concurrentï¼šåˆå«global dispatch queueï¼Œå¯ä»¥å¹¶å‘çš„æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œ<strong>ä½†æ‰§è¡Œå®Œæˆé¡ºåºæ˜¯éšæœºçš„</strong>ã€‚ç³»ç»Ÿæä¾›å››ä¸ªå…¨å±€å¹¶å‘é˜Ÿåˆ—ï¼Œè¿™å››ä¸ªé˜Ÿåˆ—æœ‰è¿™å¯¹åº”çš„ä¼˜å…ˆçº§ï¼Œ<strong>ç”¨æˆ·æ˜¯ä¸èƒ½å¤Ÿåˆ›å»ºå…¨å±€é˜Ÿåˆ—çš„ï¼Œåªèƒ½è·å–</strong>ã€‚ </li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dipatch_queue_t queue;</span><br><span class="line">queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>



<h4 id="äºŒã€dispatch-queue-create"><a href="#äºŒã€dispatch-queue-create" class="headerlink" title="äºŒã€dispatch_queue_create"></a>äºŒã€dispatch_queue_create</h4><ol>
<li>user create queueï¼šåˆ›å»ºè‡ªå·±å®šä¹‰çš„é˜Ÿåˆ—ï¼Œå¯ä»¥ç”¨dispatch_queue_createå‡½æ•°ã€‚</li>
<li>å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªè‡ªå®šä¹‰çš„é˜Ÿåˆ—åï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯é˜Ÿåˆ—ç±»å‹ï¼Œé»˜è®¤NULLæˆ–è€… DISPATCH_QUEUE_SERIAL çš„æ˜¯ä¸²è¡Œï¼Œå‚æ•°ä¸º DISPATCH_QUEUE_CONCURRENT ä¸ºå¹¶è¡Œé˜Ÿåˆ—ã€‚</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue;</span><br><span class="line">queue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.concurrentqueue&quot;</span>, DISPATCH_QUEUE_CONCURRENT);</span><br></pre></td></tr></table></figure>



<h4 id="ä¸‰ã€é˜Ÿåˆ—ä¼˜å…ˆçº§"><a href="#ä¸‰ã€é˜Ÿåˆ—ä¼˜å…ˆçº§" class="headerlink" title="ä¸‰ã€é˜Ÿåˆ—ä¼˜å…ˆçº§"></a>ä¸‰ã€é˜Ÿåˆ—ä¼˜å…ˆçº§</h4><ol>
<li>è‡ªå®šä¹‰é˜Ÿåˆ—çš„ä¼˜å…ˆçº§ï¼šå¯ä»¥é€šè¿‡dipatch_queue_attr_make_with_qos_classæˆ–dispatch_set_target_queueæ–¹æ³•è®¾ç½®é˜Ÿåˆ—çš„ä¼˜å…ˆçº§</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//dipatch_queue_attr_make_with_qos_class</span></span><br><span class="line">dispatch_queue_attr_t attr = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_SERIAL, </span><br><span class="line">                                                                     QOS_CLASS_UTILITY, <span class="number">-1</span>);</span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.qosqueue&quot;</span>, attr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//dispatch_set_target_queue</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.settargetqueue&quot;</span>,</span><br><span class="line">                                               <span class="literal">NULL</span>); <span class="comment">//éœ€è¦è®¾ç½®ä¼˜å…ˆçº§çš„queue</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> referQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW, </span><br><span class="line">                                                        <span class="number">0</span>); <span class="comment">//å‚è€ƒä¼˜å…ˆçº§</span></span><br><span class="line">dispatch_set_target_queue(queue, referQueue); <span class="comment">//è®¾ç½®queueå’ŒreferQueueçš„ä¼˜å…ˆçº§ä¸€æ ·</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>dispatch_set_target_queueï¼šå¯ä»¥è®¾ç½®ä¼˜å…ˆçº§ï¼Œä¹Ÿå¯ä»¥è®¾ç½®é˜Ÿåˆ—å±‚çº§ä½“ç³»ï¼Œæ¯”å¦‚è®©å¤šä¸ªä¸²è¡Œå’Œå¹¶è¡Œé˜Ÿåˆ—åœ¨ç»Ÿä¸€ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—é‡Œä¸²è¡Œæ‰§è¡Œï¼Œå¦‚ä¸‹</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.serialqueue&quot;</span>, </span><br><span class="line">                                                     DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="built_in">dispatch_queue_t</span> firstQueue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.firstqueue&quot;</span>, </span><br><span class="line">                                                    DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="built_in">dispatch_queue_t</span> secondQueue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.secondqueue&quot;</span>, </span><br><span class="line">                                                     DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"></span><br><span class="line">dispatch_set_target_queue(firstQueue, serialQueue);</span><br><span class="line">dispatch_set_target_queue(secondQueue, serialQueue);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(firstQueue, ^&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;1&quot;</span>);</span><br><span class="line">  [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3.</span>f];</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(secondQueue, ^&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;2&quot;</span>);</span><br><span class="line">  [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2.</span>f];</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(secondQueue, ^&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;3&quot;</span>);</span><br><span class="line">  [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1.</span>f];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h3 id="é˜Ÿåˆ—ç±»å‹"><a href="#é˜Ÿåˆ—ç±»å‹" class="headerlink" title="é˜Ÿåˆ—ç±»å‹"></a>é˜Ÿåˆ—ç±»å‹</h3><p><strong>é˜Ÿåˆ—é»˜è®¤æ˜¯ä¸²è¡Œçš„ï¼Œå¦‚æœè®¾ç½®è¯¥å‚æ•°ä¸ºNULLä¼šæŒ‰ä¸²è¡Œå¤„ç†ï¼Œåªèƒ½æ‰§è¡Œä¸€ä¸ªå•ç‹¬çš„blockï¼Œé˜Ÿåˆ—ä¹Ÿå¯ä»¥æ˜¯å¹¶è¡Œçš„ï¼ŒåŒä¸€æ—¶é—´æ‰§è¡Œå¤šä¸ªblock</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)init &#123;</span><br><span class="line">  <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">self</span> != <span class="literal">nil</span>) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *label = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@.isolation.%p&quot;</span>, [<span class="keyword">self</span> <span class="keyword">class</span>], <span class="keyword">self</span>];</span><br><span class="line">    <span class="keyword">self</span>.isolationQueue = dispatch_queue_create([label UTF8String], <span class="number">0</span>);</span><br><span class="line">    label = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@.work.%p&quot;</span>, [<span class="keyword">self</span> <span class="keyword">class</span>], <span class="keyword">self</span>];</span><br><span class="line">    <span class="keyword">self</span>.workQueue = dispatch_queue_create([label UTF8String], <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="ä¸€ã€5ç§é˜Ÿåˆ—"><a href="#ä¸€ã€5ç§é˜Ÿåˆ—" class="headerlink" title="ä¸€ã€5ç§é˜Ÿåˆ—"></a>ä¸€ã€5ç§é˜Ÿåˆ—</h4><p>ä¸»é˜Ÿåˆ—ï¼ˆmain queueï¼‰, å››ç§é€šç”¨è°ƒåº¦é˜Ÿåˆ—ï¼Œè‡ªå·±å®šåˆ¶çš„é˜Ÿåˆ—ã€‚å››ç§é€šç”¨è°ƒåº¦é˜Ÿåˆ—ä¸º ï¼š</p>
<ol>
<li><p><strong>QOS_CLASS_USER_INTERACTIVE</strong>ï¼šuser interactiveç­‰çº§è¡¨ç¤ºä»»åŠ¡éœ€è¦è¢«ç«‹å³æ‰§è¡Œæä¾›å¥½çš„ä½“éªŒï¼Œç”¨æ¥æ›´æ–°UIï¼Œå“åº”äº‹ä»¶ç­‰ã€‚è¿™ä¸ªç­‰çº§æœ€å¥½ä¿æŒå°è§„æ¨¡ã€‚ </p>
</li>
<li><p><strong>QOS_CLASS_USER_INITIATED</strong>ï¼šuser initiatedç­‰çº§è¡¨ç¤ºä»»åŠ¡ç”±UIå‘èµ·å¼‚æ­¥æ‰§è¡Œã€‚é€‚ç”¨åœºæ™¯æ˜¯éœ€è¦åŠæ—¶ç»“æœåŒæ—¶åˆå¯ä»¥ç»§ç»­äº¤äº’çš„æ—¶å€™ã€‚</p>
</li>
<li><p><strong>QOS_CLASS_UTILITY</strong>ï¼šutilityç­‰çº§è¡¨ç¤ºéœ€è¦é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼Œä¼´æœ‰ç”¨æˆ·å¯è§è¿›åº¦æŒ‡ç¤ºå™¨ã€‚ç»å¸¸ä¼šç”¨æ¥åšè®¡ç®—ï¼ŒI/Oï¼Œç½‘ç»œï¼ŒæŒç»­çš„æ•°æ®å¡«å……ç­‰ä»»åŠ¡ã€‚è¿™ä¸ªä»»åŠ¡èŠ‚èƒ½ã€‚ </p>
</li>
<li><p><strong>QOS_CLASS_BACKGROUND</strong>ï¼šbackgroundç­‰çº§è¡¨ç¤ºç”¨æˆ·ä¸ä¼šå¯Ÿè§‰çš„ä»»åŠ¡ï¼Œä½¿ç”¨å®ƒæ¥å¤„ç†é¢„åŠ è½½ï¼Œ æˆ–è€…ä¸éœ€è¦ç”¨æˆ·äº¤äº’å’Œå¯¹æ—¶é—´ä¸æ•æ„Ÿçš„ä»»åŠ¡ã€‚ </p>
</li>
</ol>
<p><strong>ç¤ºä¾‹ï¼šåå°åŠ è½½æ˜¾ç¤ºå›¾ç‰‡</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span>()</span> &#123;</span><br><span class="line">  <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">  dispatch_async(dispatch_get_global_queue(<span class="type">Int</span>(<span class="type">QOS_CLASS_USER_INITIATED</span>.value), <span class="number">0</span>)) &#123;</span><br><span class="line">	<span class="comment">// å°†å·¥ä½œä»ä¸»çº¿ç¨‹è½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ï¼Œè¿™æ˜¯dispatch_asyncè°ƒç”¨ï¼Œå¼‚æ­¥æäº¤ä¿è¯è°ƒç”¨çº¿ç¨‹ä¼šç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œè¿™æ ·viewDidLoadåœ¨ä¸»çº¿ç¨‹ä¸Šèƒ½å¤Ÿæ›´æ—©å®Œæˆï¼Œ</span></span><br><span class="line">    <span class="keyword">let</span> overlayImage <span class="operator">=</span> <span class="keyword">self</span>.faceOverlayImageFromImage(<span class="keyword">self</span>.image)</span><br><span class="line">		dispatch_async(dispatch_get_main_queue()) &#123;</span><br><span class="line">      <span class="comment">// æ–°å›¾å®Œæˆï¼ŒæŠŠä¸€ä¸ªé—­åŒ…åŠ å…¥ä¸»çº¿ç¨‹ç”¨æ¥æ›´æ–°UIImageViewï¼Œåªæœ‰åœ¨ä¸»çº¿ç¨‹èƒ½æ“ä½œUIKitã€‚</span></span><br><span class="line">      <span class="keyword">self</span>.fadeInNewImage(overlayImage) <span class="comment">// æ›´æ–°UI</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="äºŒã€ä½•æ—¶ä½¿ç”¨ä½•ç§é˜Ÿåˆ—ç±»å‹"><a href="#äºŒã€ä½•æ—¶ä½¿ç”¨ä½•ç§é˜Ÿåˆ—ç±»å‹" class="headerlink" title="äºŒã€ä½•æ—¶ä½¿ç”¨ä½•ç§é˜Ÿåˆ—ç±»å‹"></a>äºŒã€ä½•æ—¶ä½¿ç”¨ä½•ç§é˜Ÿåˆ—ç±»å‹</h4><ol>
<li>ä¸»é˜Ÿåˆ—ï¼ˆé¡ºåºï¼‰ï¼š<strong>é˜Ÿåˆ—ä¸­æœ‰ä»»åŠ¡å®Œæˆéœ€è¦æ›´æ–°UIæ—¶ï¼Œdispatch_afteråœ¨è¿™ç§ç±»å‹ä¸­ä½¿ç”¨</strong>ã€‚</li>
<li>å¹¶å‘é˜Ÿåˆ—ï¼š<strong>ç”¨æ¥æ‰§è¡Œä¸UIæ— å…³çš„åå°ä»»åŠ¡</strong>ï¼Œdispatch_syncæ”¾åœ¨è¿™é‡Œï¼Œæ–¹ä¾¿ç­‰å¾…ä»»åŠ¡ï¼Œå®Œæˆè¿›è¡Œåç»­å¤„ç†æˆ–å’Œdispatch barrieråŒæ­¥ã€‚dispatch groupsæ”¾åœ¨è¿™é‡Œä¹Ÿä¸é”™ã€‚</li>
<li>è‡ªå®šä¹‰é¡ºåºé˜Ÿåˆ—ï¼šé¡ºåºæ‰§è¡Œåå°ä»»åŠ¡å¹¶è¿½è¸ªå®ƒæ—¶ã€‚è¿™æ ·åšåŒæ—¶åªæœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œå¯ä»¥é˜²æ­¢èµ„æºç«äº‰ã€‚dipatch barriersè§£å†³è¯»å†™é”é—®é¢˜çš„æ”¾åœ¨è¿™é‡Œå¤„ç†ã€‚dispatch groupsä¹Ÿæ˜¯æ”¾åœ¨è¿™é‡Œã€‚ </li>
</ol>
<h4 id="ä¸‰ã€QoSç­‰çº§å‚æ•°çš„å†™æ³•"><a href="#ä¸‰ã€QoSç­‰çº§å‚æ•°çš„å†™æ³•" class="headerlink" title="ä¸‰ã€QoSç­‰çº§å‚æ•°çš„å†™æ³•"></a>ä¸‰ã€QoSç­‰çº§å‚æ•°çš„å†™æ³•</h4><p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•ç®€åŒ–QoSç­‰çº§å‚æ•°çš„å†™æ³• </p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="type">GlobalMainQueue</span>: dispatch_queue_t &#123;</span><br><span class="line">  <span class="keyword">return</span> dispatch_get_main_queue()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="type">GlobalUserInteractiveQueue</span>: dispatch_queue_t &#123;</span><br><span class="line">  <span class="keyword">return</span> dispatch_get_global_queue(<span class="type">Int</span>(<span class="type">QOS_CLASS_USER_INTERACTIVE</span>.value), <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="type">GlobalUserInitiatedQueue</span>: dispatch_queue_t &#123;</span><br><span class="line">  <span class="keyword">return</span> dispatch_get_global_queue(<span class="type">Int</span>(<span class="type">QOS_CLASS_USER_INITIATED</span>.value), <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="type">GlobalUtilityQueue</span>: dispatch_queue_t &#123;</span><br><span class="line">  <span class="keyword">return</span> dispatch_get_global_queue(<span class="type">Int</span>(<span class="type">QOS_CLASS_UTILITY</span>.value), <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="type">GlobalBackgroundQueue</span>: dispatch_queue_t &#123;</span><br><span class="line">  <span class="keyword">return</span> dispatch_get_global_queue(<span class="type">Int</span>(<span class="type">QOS_CLASS_BACKGROUND</span>.value), <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨èµ·æ¥å°±æ˜¯è¿™æ ·ï¼Œæ˜“è¯»è€Œä¸”å®¹æ˜“çœ‹å‡ºåœ¨ä½¿ç”¨å“ªä¸ªé˜Ÿåˆ—</span></span><br><span class="line">dispatch_async(<span class="type">GlobalUserInitiatedQueue</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> overlayImage <span class="operator">=</span> <span class="keyword">self</span>.faceOverlayImageFromImage(<span class="keyword">self</span>.image)</span><br><span class="line">  dispatch_async(<span class="type">GlobalMainQueue</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.fadeInNewImage(overlayImage)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h2><h3 id="ç®€å•ä½¿ç”¨å’Œä»‹ç»"><a href="#ç®€å•ä½¿ç”¨å’Œä»‹ç»" class="headerlink" title="ç®€å•ä½¿ç”¨å’Œä»‹ç»"></a>ç®€å•ä½¿ç”¨å’Œä»‹ç»</h3><h4 id="ä¸€ã€dispatch-onceç”¨æ³•"><a href="#ä¸€ã€dispatch-onceç”¨æ³•" class="headerlink" title="ä¸€ã€dispatch_onceç”¨æ³•"></a>ä¸€ã€dispatch_onceç”¨æ³•</h4><p>â€‹    <strong>dispatch_once_t è¦æ˜¯å…¨å±€æˆ–staticå˜é‡ï¼Œä¿è¯dispatch_once_tåªæœ‰ä¸€ä»½å®ä¾‹</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">UIColor</span> *)boringColor &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">UIColor</span> *color;</span><br><span class="line">  <span class="comment">//åªè¿è¡Œä¸€æ¬¡</span></span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">  <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">    color = [<span class="built_in">UIColor</span> colorWithRed:<span class="number">0.380</span>f green:<span class="number">0.376</span>f blue:<span class="number">0.376</span>f alpha:<span class="number">1.000</span>f];</span><br><span class="line">	&#125;);</span><br><span class="line">  <span class="keyword">return</span> color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="äºŒã€dispatch-async"><a href="#äºŒã€dispatch-async" class="headerlink" title="äºŒã€dispatch_async"></a>äºŒã€dispatch_async</h4><p>â€‹    è®¾è®¡ä¸€ä¸ªå¼‚æ­¥çš„APIè°ƒç”¨dispatch_async()ï¼Œè¿™ä¸ªè°ƒç”¨æ”¾åœ¨APIçš„æ–¹æ³•æˆ–å‡½æ•°ä¸­åšã€‚è®©APIçš„ä½¿ç”¨è€…è®¾ç½®ä¸€ä¸ªå›è°ƒå¤„ç†é˜Ÿåˆ—ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)processImage:(<span class="built_in">UIImage</span> *)image completionHandler:(<span class="keyword">void</span>(^)(<span class="built_in">BOOL</span> success))handler &#123;</span><br><span class="line">  <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.isolationQueue, ^(<span class="keyword">void</span>)&#123;</span><br><span class="line">    <span class="comment">// do actual processing here</span></span><br><span class="line">    <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.resultQueue, ^(<span class="keyword">void</span>)&#123;</span><br><span class="line">      handler(<span class="literal">YES</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è±†ç“£ä¸­æ•°æ®åŠ è½½çš„æ—¶å€™ç”¨åˆ°çš„å°±æ˜¯è¿™ç§æ–¹æ³•ï¼Œæ•°æ®å¤„ç†ä¸­ä½¿ç”¨</p>
<p><strong>å¯ä»¥é¿å…ç•Œé¢ä¼šè¢«ä¸€äº›è€—æ—¶çš„æ“ä½œå¡æ­»ï¼Œæ¯”å¦‚è¯»å–ç½‘ç»œæ•°æ®ï¼Œå¤§æ•°æ®IOï¼Œè¿˜æœ‰å¤§é‡æ•°æ®çš„æ•°æ®åº“è¯»å†™ï¼Œè¿™æ—¶éœ€è¦åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­å¤„ç†ï¼Œç„¶åé€šçŸ¥ä¸»çº¿ç¨‹æ›´æ–°ç•Œé¢ï¼ŒGCDä½¿ç”¨èµ·æ¥æ¯”NSThreadå’ŒNSOperationæ–¹æ³•è¦ç®€å•æ–¹ä¾¿ã€‚</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä»£ç æ¡†æ¶</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">  <span class="comment">// è€—æ—¶çš„æ“ä½œ</span></span><br><span class="line">  <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    <span class="comment">// æ›´æ–°ç•Œé¢</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹è½½å›¾ç‰‡çš„ç¤ºä¾‹</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">  <span class="built_in">NSURL</span> * url = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@&quot;&lt;http://avatar.csdn.net/2/C/D/1_totogo2010.jpg&gt;&quot;</span>];</span><br><span class="line">  <span class="built_in">NSData</span> * data = [[<span class="built_in">NSData</span> alloc]initWithContentsOfURL:url];</span><br><span class="line">  <span class="built_in">UIImage</span> *image = [[<span class="built_in">UIImage</span> alloc]initWithData:data];</span><br><span class="line">  <span class="keyword">if</span> (data != <span class="literal">nil</span>) &#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">      <span class="keyword">self</span>.imageView.image = image;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h4 id="ä¸‰ã€dispatch-afterå»¶åæ‰§è¡Œ"><a href="#ä¸‰ã€dispatch-afterå»¶åæ‰§è¡Œ" class="headerlink" title="ä¸‰ã€dispatch_afterå»¶åæ‰§è¡Œ"></a>ä¸‰ã€dispatch_afterå»¶åæ‰§è¡Œ</h4><p><strong>dispatch_afteråªæ˜¯å»¶æ—¶æäº¤blockï¼Œä¸æ˜¯å»¶æ—¶ç«‹åˆ»æ‰§è¡Œã€‚</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)foo &#123;</span><br><span class="line">  <span class="keyword">double</span> delayInSeconds = <span class="number">2.0</span>;</span><br><span class="line">  dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, </span><br><span class="line">                                          (int64_t) (delayInSeconds * <span class="built_in">NSEC_PER_SEC</span>));</span><br><span class="line">  dispatch_after(popTime, dispatch_get_main_queue(), ^(<span class="keyword">void</span>)&#123;</span><br><span class="line">    [<span class="keyword">self</span> bar];</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>èŒƒä¾‹ï¼Œå®ç°ä¸€ä¸ªæ¨è¿Ÿå‡ºç°å¼¹å‡ºæ¡†æç¤ºï¼Œæ¯”å¦‚è¯´æç¤ºç”¨æˆ·è¯„ä»·ç­‰åŠŸèƒ½ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">showOrHideNavPrompt</span>()</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> delayInSeconds <span class="operator">=</span> <span class="number">1.0</span></span><br><span class="line">  <span class="keyword">let</span> popTime <span class="operator">=</span> dispatch_time(<span class="type">DISPATCH_TIME_NOW</span>,</span><br><span class="line">                              <span class="type">Int64</span>(delayInSeconds <span class="operator">*</span> <span class="type">Double</span>(<span class="type">NSEC_PER_SEC</span>))) <span class="comment">// åœ¨è¿™é‡Œå£°æ˜æ¨è¿Ÿçš„æ—¶é—´</span></span><br><span class="line">  dispatch_after(popTime, <span class="type">GlobalMainQueue</span>) &#123; <span class="comment">// ç­‰å¾…delayInSecondså°†é—­åŒ…å¼‚æ­¥åˆ°ä¸»é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">let</span> count <span class="operator">=</span> <span class="type">PhotoManager</span>.sharedManager.photos.count</span><br><span class="line">    <span class="keyword">if</span> count <span class="operator">&gt;</span> <span class="number">0</span> &#123;</span><br><span class="line">      <span class="keyword">self</span>.navigationItem.prompt <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">self</span>.navigationItem.prompt <span class="operator">=</span> <span class="string">&quot;Add photos with faces to Googlyify them!&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¾‹å­ä¸­çš„dispatch timeçš„å‚æ•°ï¼Œå¯ä»¥å…ˆçœ‹çœ‹å‡½æ•°åŸå‹ </p>
<p><code>dispatch_time_t dispatch_time ( dispatch_time_t when, int64_t delta ); </code></p>
<p>ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºDISPATCH_TIME_NOWè¡¨ç¤ºå½“å‰ã€‚ç¬¬äºŒä¸ªå‚æ•°çš„deltaè¡¨ç¤ºçº³ç§’ï¼Œä¸€ç§’å¯¹åº”çš„çº³ç§’ä¸º1000000000ï¼Œç³»ç»Ÿæä¾›äº†ä¸€äº›å®æ¥ç®€åŒ– </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NSEC_PER_SEC 1000000000ull <span class="comment">//æ¯ç§’æœ‰å¤šå°‘çº³ç§’</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USEC_PER_SEC 1000000ull <span class="comment">//æ¯ç§’æœ‰å¤šå°‘æ¯«ç§’</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NSEC_PER_USEC 1000ull <span class="comment">//æ¯æ¯«ç§’æœ‰å¤šå°‘çº³ç§’</span></span></span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å¦‚æœè¦è¡¨ç¤ºä¸€ç§’å°±å¯ä»¥è¿™æ ·å†™ </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dispatch_time(DISPATCH_TIME_NOW, <span class="number">1</span> * <span class="built_in">NSEC_PER_SEC</span>);</span><br><span class="line">dispatch_time(DISPATCH_TIME_NOW, <span class="number">1000</span> * USEC_PER_SEC);</span><br><span class="line">dispatch_time(DISPATCH_TIME_NOW, USEC_PER_SEC * <span class="built_in">NSEC_PER_USEC</span>);</span><br></pre></td></tr></table></figure>



<h4 id="å››ã€dispatch-barrier-asyncä½¿ç”¨Barrier-Taskæ–¹æ³•"><a href="#å››ã€dispatch-barrier-asyncä½¿ç”¨Barrier-Taskæ–¹æ³•" class="headerlink" title="å››ã€dispatch_barrier_asyncä½¿ç”¨Barrier Taskæ–¹æ³•"></a>å››ã€dispatch_barrier_asyncä½¿ç”¨Barrier Taskæ–¹æ³•</h4><ol>
<li>Dispatch Barrierè§£å†³å¤šçº¿ç¨‹å¹¶å‘è¯»å†™åŒä¸€ä¸ªèµ„æºå‘ç”Ÿæ­»é”</li>
<li>Dispatch Barrierç¡®ä¿æäº¤çš„é—­åŒ…æ˜¯æŒ‡å®šé˜Ÿåˆ—ä¸­åœ¨ç‰¹å®šæ—¶æ®µå”¯ä¸€åœ¨æ‰§è¡Œçš„ä¸€ä¸ªã€‚ </li>
<li>åœ¨æ‰€æœ‰å…ˆäºDispatch Barrierçš„ä»»åŠ¡éƒ½å®Œæˆçš„æƒ…å†µä¸‹è¿™ä¸ªé—­åŒ…æ‰å¼€å§‹æ‰§è¡Œã€‚ </li>
<li>è½®åˆ°è¿™ä¸ªé—­åŒ…æ—¶barrierä¼šæ‰§è¡Œè¿™ä¸ªé—­åŒ…å¹¶ä¸”ç¡®ä¿é˜Ÿåˆ—åœ¨æ­¤è¿‡ç¨‹ä¸ä¼šæ‰§è¡Œå…¶å®ƒä»»åŠ¡ã€‚ </li>
<li>é—­åŒ…å®Œæˆå é˜Ÿåˆ—æ¢å¤ã€‚ </li>
<li><strong>éœ€è¦æ³¨æ„dispatch_barrier_asyncåªåœ¨è‡ªå·±åˆ›å»ºçš„é˜Ÿåˆ—ä¸Šæœ‰è¿™ç§ä½œç”¨ï¼Œåœ¨å…¨å±€å¹¶å‘é˜Ÿåˆ—å’Œä¸²è¡Œé˜Ÿåˆ—ä¸Šï¼Œæ•ˆæœå’Œ dispatch_syncä¸€æ ·</strong></li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºé˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">self</span>.isolationQueue = dispatch_queue_create([label UTF8String], DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"><span class="comment">//æ”¹å˜setter</span></span><br><span class="line">- (<span class="keyword">void</span>)setCount:(<span class="built_in">NSUInteger</span>)count forKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">  key = [key <span class="keyword">copy</span>];</span><br><span class="line">  <span class="comment">//ç¡®ä¿æ‰€æœ‰barrieréƒ½æ˜¯asyncå¼‚æ­¥çš„</span></span><br><span class="line">  dispatch_barrier_async(<span class="keyword">self</span>.isolationQueue, ^()&#123;</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">      [<span class="keyword">self</span>.counts removeObjectForKey:key];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">self</span>.counts[key] = @(count);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dispatchBarrierAsyncDemo &#123;</span><br><span class="line">    <span class="comment">//é˜²æ­¢æ–‡ä»¶è¯»å†™å†²çªï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œæ“ä½œéƒ½åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸­è¿›è¡Œï¼Œæ²¡æœ‰æ›´æ–°æ•°æ®è¯»ç”¨å¹¶è¡Œï¼Œå†™ç”¨ä¸²è¡Œã€‚</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> dataQueue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.dataqueue&quot;</span>,</span><br><span class="line">                                                       DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dataQueue, ^&#123;</span><br><span class="line">      [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2.</span>f];</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;read data 1&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">dispatch_async</span>(dataQueue, ^&#123;</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;read data 2&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//ç­‰å¾…å‰é¢çš„éƒ½å®Œæˆï¼Œåœ¨æ‰§è¡Œbarrieråé¢çš„</span></span><br><span class="line">    dispatch_barrier_async(dataQueue, ^&#123;</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;write data 1&quot;</span>);</span><br><span class="line">      [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dataQueue, ^&#123;</span><br><span class="line">      [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1.</span>f];</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;read data 3&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dataQueue, ^&#123;</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;read data 4&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>swiftç¤ºä¾‹</strong></p>
<p>ä½¿ç”¨dispatch_queue_createåˆå§‹åŒ–ä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—ã€‚ç¬¬ä¸€ä¸ªå‚æ•°éµå¾ª<strong>åå‘DNSå‘½åä¹ æƒ¯</strong>ï¼Œæ–¹ä¾¿æè¿°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æŒ‡å‡ºæ˜¯å¹¶å‘è¿˜æ˜¯é¡ºåºã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">let</span> concurrentPhotoQueue <span class="operator">=</span> dispatch_queue_create(<span class="string">&quot;com.raywenderlich.GooglyPuff.photoQueue&quot;</span>, <span class="type">DISPATCH_QUEUE_CONCURRENT</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addPhoto</span>(<span class="params">photo</span>: <span class="type">Photo</span>)</span> &#123;</span><br><span class="line">  dispatch_barrier_async(concurrentPhotoQueue) &#123;</span><br><span class="line">    <span class="comment">// å°†å†™æ“ä½œåŠ å…¥åˆ°è‡ªå®šä¹‰çš„é˜Ÿåˆ—ã€‚å¼€å§‹æ‰§è¡Œæ—¶è¿™ä¸ªå°±æ˜¯é˜Ÿåˆ—ä¸­å”¯ä¸€çš„ä¸€ä¸ªåœ¨æ‰§è¡Œçš„ä»»åŠ¡ã€‚</span></span><br><span class="line">    <span class="keyword">self</span>._photos.append(photo) </span><br><span class="line">    <span class="comment">// barrierèƒ½å¤Ÿä¿éšœä¸ä¼šå’Œå…¶ä»–ä»»åŠ¡åŒæ—¶è¿›è¡Œã€‚</span></span><br><span class="line">    dispatch_async(<span class="type">GlobalMainQueue</span>) &#123; </span><br><span class="line">      <span class="comment">// æ¶‰åŠåˆ°UIæ‰€ä»¥è¿™ä¸ªé€šçŸ¥åº”è¯¥åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œæ‰€ä»¥åˆ†æ´¾å¦ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡åˆ°ä¸»é˜Ÿåˆ—ä¸­ã€‚</span></span><br><span class="line">      <span class="keyword">self</span>.postContentAddedNotification()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¯è§£å†³äº†å†™å¯èƒ½å‘ç”Ÿæ­»é”ï¼Œä¸‹é¢æ˜¯ä½¿ç”¨dispatch_syncè§£å†³è¯»æ—¶å¯èƒ½ä¼šå‘ç”Ÿçš„æ­»é”ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> photos: [<span class="type">Photo</span>] &#123;</span><br><span class="line">  <span class="keyword">var</span> photosCopy: [<span class="type">Photo</span>]<span class="operator">!</span></span><br><span class="line">  dispatch_sync(concurrentPhotoQueue) &#123; <span class="comment">// åŒæ­¥è°ƒåº¦åˆ°concurrentPhotoQueueé˜Ÿåˆ—æ‰§è¡Œè¯»æ“ä½œ</span></span><br><span class="line">    photosCopy <span class="operator">=</span> <span class="keyword">self</span>._photos <span class="comment">// ä¿å­˜</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> photosCopy</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·è¯»å†™é—®é¢˜éƒ½è§£å†³äº†ã€‚éƒ½ç”¨å¼‚æ­¥å¤„ç†é¿å…æ­»é”ï¼Œå¼‚æ­¥çš„ç¼ºç‚¹åœ¨äºè°ƒè¯•ä¸æ–¹ä¾¿ï¼Œä½†æ˜¯æ¯”èµ·åŒæ­¥å®¹æ˜“äº§ç”Ÿæ­»é”è¿™ä¸ªå‰¯ä½œç”¨è¿˜ç®—å°çš„ã€‚</p>
<h4 id="äº”ã€dispatch-applyè¿›è¡Œå¿«é€Ÿè¿­ä»£"><a href="#äº”ã€dispatch-applyè¿›è¡Œå¿«é€Ÿè¿­ä»£" class="headerlink" title="äº”ã€dispatch_applyè¿›è¡Œå¿«é€Ÿè¿­ä»£"></a>äº”ã€dispatch_applyè¿›è¡Œå¿«é€Ÿè¿­ä»£</h4><p>ç±»ä¼¼forå¾ªç¯ï¼Œä½†æ˜¯åœ¨å¹¶å‘é˜Ÿåˆ—çš„æƒ…å†µä¸‹dispatch_applyä¼šå¹¶å‘æ‰§è¡Œblockä»»åŠ¡ã€‚ </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (size_t y = <span class="number">0</span>; y &lt; height; ++y) &#123;</span><br><span class="line">  <span class="keyword">for</span> (size_t x = <span class="number">0</span>; x &lt; width; ++x) &#123;</span><br><span class="line">    <span class="comment">// Do something with x and y here</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºå¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œæ‰€ä»¥ä½¿ç”¨dispatch_applyå¯ä»¥è¿è¡Œçš„æ›´å¿« </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dispatchApplyDemo &#123;</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> concurrentQueue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.concurre</span></span><br><span class="line"><span class="string">    dispatch_apply(10, concurrentQueue, ^(size_t i) &#123;</span></span><br><span class="line"><span class="string">        NSLog(@&quot;</span>%zu<span class="string">&quot;,i);</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    NSLog(@&quot;</span>The end<span class="string">&quot;);</span></span><br><span class="line"><span class="string">    //è¿™é‡Œæœ‰ä¸ªéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œdispatch_applyè¿™ä¸ªæ˜¯ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„ã€‚è¿™ä¸ªlogæ‰“å°ä¼šåœ¨dispatch_applyéƒ½ç»“æŸåæ‰å¼€å§‹æ‰§è¡Œ</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>dispatch_applyèƒ½é¿å…çº¿ç¨‹çˆ†ç‚¸ï¼Œå› ä¸ºGCDä¼šç®¡ç†å¹¶å‘</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dealWiththreadWithMaybeExplode:(<span class="built_in">BOOL</span>)explode &#123;</span><br><span class="line">  <span class="built_in">dispatch_queue_t</span> concurrentQueue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.concurrentqueue&quot;</span>,DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">  <span class="keyword">if</span> (explode) &#123;</span><br><span class="line">    <span class="comment">//æœ‰é—®é¢˜çš„æƒ…å†µï¼Œå¯èƒ½ä¼šæ­»é”</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">999</span> ; i++) &#123;</span><br><span class="line">      <span class="built_in">dispatch_async</span>(concurrentQueue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;wrong %d&quot;</span>,i);</span><br><span class="line">        <span class="comment">//do something hard</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//ä¼šä¼˜åŒ–å¾ˆå¤šï¼Œèƒ½å¤Ÿåˆ©ç”¨GCDç®¡ç†</span></span><br><span class="line">    dispatch_apply(<span class="number">999</span>, concurrentQueue, ^(size_t i)&#123;</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;correct %zu&quot;</span>,i);</span><br><span class="line">      <span class="comment">//do something hard</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>swiftç¤ºä¾‹ï¼š </p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">downloadPhotosWithCompletion</span>(<span class="params">completion</span>: <span class="type">BatchPhotoDownloadingCompletionClosure</span>?)</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> storedError: <span class="type">NSError</span>!</span><br><span class="line">  <span class="keyword">var</span> downloadGroup <span class="operator">=</span> dispatch_group_create()</span><br><span class="line">  <span class="keyword">let</span> addresses <span class="operator">=</span> [<span class="type">OverlyAttachedGirlfriendURLString</span>, </span><br><span class="line">                   <span class="type">SuccessKidURLString</span>,</span><br><span class="line">                   <span class="type">LotsOfFacesURLString</span>]</span><br><span class="line">  dispatch_apply(<span class="type">UInt</span>(addresses.count), <span class="type">GlobalUserInitiatedQueue</span>) &#123;</span><br><span class="line">    i <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">let</span> index <span class="operator">=</span> <span class="type">Int</span>(i)</span><br><span class="line">    <span class="keyword">let</span> address <span class="operator">=</span> addresses[index]</span><br><span class="line">    <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">NSURL</span>(string: address)</span><br><span class="line">    dispatch_group_enter(downloadGroup)</span><br><span class="line">    <span class="keyword">let</span> photo <span class="operator">=</span> <span class="type">DownloadPhoto</span>(url: url<span class="operator">!</span>) &#123;</span><br><span class="line">      image, error <span class="keyword">in</span> </span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">let</span> error <span class="operator">=</span> error &#123;</span><br><span class="line">        storedError <span class="operator">=</span> error</span><br><span class="line">      &#125;</span><br><span class="line">      dispatch_group_leave(downloadGroup)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">PhotoManager</span>.sharedManager.addPhoto(photo)</span><br><span class="line">  &#125;</span><br><span class="line">  dispatch_group_notify(downloadGroup, <span class="type">GlobalMainQueue</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> completion <span class="operator">=</span> completion &#123;</span><br><span class="line">      completion(error: storedError)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="å…­ã€Blockç»„åˆDispatch-groups"><a href="#å…­ã€Blockç»„åˆDispatch-groups" class="headerlink" title="å…­ã€Blockç»„åˆDispatch_groups"></a>å…­ã€Blockç»„åˆDispatch_groups</h4><p>dispatch groupsæ˜¯ä¸“é—¨ç”¨æ¥ç›‘è§†å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ã€‚dispatch_group_tå®ä¾‹ç”¨æ¥è¿½è¸ªä¸åŒé˜Ÿåˆ—ä¸­çš„ä¸åŒä»»åŠ¡ã€‚</p>
<p>å½“groupé‡Œæ‰€æœ‰äº‹ä»¶éƒ½å®ŒæˆGCD APIæœ‰ä¸¤ç§æ–¹å¼å‘é€é€šçŸ¥: </p>
<ul>
<li>ç¬¬ä¸€ç§æ˜¯dispatch_group_waitï¼Œä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œç­‰æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆæˆ–ç­‰å¾…è¶…æ—¶ã€‚ </li>
<li>ç¬¬äºŒç§æ–¹æ³•æ˜¯ä½¿ç”¨dispatch_group_notifyï¼Œå¼‚æ­¥æ‰§è¡Œé—­åŒ…ï¼Œä¸ä¼šé˜»å¡ã€‚ </li>
</ul>
<ol>
<li>ç¬¬ä¸€ç§ä½¿ç”¨dispatch_group_waitçš„swiftçš„ä¾‹å­ï¼š </li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">downloadPhotosWithCompletion</span>(<span class="params">completion</span>: <span class="type">BatchPhotoDownloadingCompletionClosure</span>?)</span> &#123;</span><br><span class="line">  dispatch_async(<span class="type">GlobalUserInitiatedQueue</span>) &#123;</span><br><span class="line">    <span class="comment">// å› ä¸ºdispatch_group_waitä¼šç§Ÿå¡å½“å‰è¿›ç¨‹ï¼Œæ‰€ä»¥è¦ä½¿ç”¨dispatch_asyncå°†æ•´ä¸ªæ–¹æ³•è¦æ”¾åˆ°åå°é˜Ÿåˆ—æ‰èƒ½å¤Ÿä¿è¯ä¸»çº¿ç¨‹ä¸è¢«é˜»å¡</span></span><br><span class="line">    <span class="keyword">var</span> storedError: <span class="type">NSError</span>!</span><br><span class="line">    <span class="keyword">var</span> downloadGroup <span class="operator">=</span> dispatch_group_create() <span class="comment">// åˆ›å»ºä¸€ä¸ªdispatch group</span></span><br><span class="line">    <span class="keyword">let</span> addresses <span class="operator">=</span> [<span class="type">OverlyAttachedGirlfriendURLString</span>,</span><br><span class="line">                     <span class="type">SuccessKidURLString</span>,``</span><br><span class="line">                     <span class="type">LotsOfFacesURLString</span>]</span><br><span class="line">    <span class="keyword">for</span> address <span class="keyword">in</span> addresses &#123;</span><br><span class="line">      <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">NSURL</span>(string: address)</span><br><span class="line">      dispatch_group_enter(downloadGroup)</span><br><span class="line">        <span class="comment">// dispatch_group_enteræ˜¯é€šçŸ¥dispatch groupä»»åŠ¡å¼€å§‹äº†ï¼Œdispatch_group_enterå’Œdispatch_group_leaveæ˜¯æˆå¯¹è°ƒç”¨ï¼Œä¸ç„¶ç¨‹åºå°±å´©æºƒäº†ã€‚</span></span><br><span class="line">      <span class="keyword">let</span> photo <span class="operator">=</span> <span class="type">DownloadPhoto</span>(url: url<span class="operator">!</span>) &#123;</span><br><span class="line">        image, error <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> error <span class="operator">=</span> error &#123;</span><br><span class="line">          storedError <span class="operator">=</span> error</span><br><span class="line">        &#125;</span><br><span class="line">        dispatch_group_leave(downloadGroup) </span><br><span class="line">        <span class="comment">// ä¿æŒå’Œdispatch_group_enteré…å¯¹ã€‚é€šçŸ¥ä»»åŠ¡å·²ç»å®Œæˆ</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">PhotoManager</span>.sharedManager.addPhoto(photo)</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_group_wait(downloadGroup, <span class="type">DISPATCH_TIME_FOREVER</span>)</span><br><span class="line">    <span class="comment">// dispatch_group_waitç­‰å¾…æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆç›´åˆ°è¶…æ—¶ã€‚å¦‚æœä»»åŠ¡å®Œæˆå‰å°±è¶…æ—¶äº†ï¼Œå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªéé›¶å€¼ï¼Œå¯ä»¥é€šè¿‡è¿”å›å€¼åˆ¤æ–­æ˜¯å¦è¶…æ—¶ã€‚ä¹Ÿå¯ä»¥ç”¨DISPATCH_TIME_FOREVERè¡¨ç¤ºä¸€ç›´ç­‰ã€‚</span></span><br><span class="line">    dispatch_async(<span class="type">GlobalMainQueue</span>) &#123;</span><br><span class="line">      <span class="comment">// è¿™é‡Œå¯ä»¥ä¿è¯æ‰€æœ‰å›¾ç‰‡ä»»åŠ¡éƒ½å®Œæˆï¼Œç„¶ååœ¨main queueé‡ŒåŠ å…¥å®Œæˆåè¦å¤„ç†çš„é—­åŒ…ï¼Œä¼šåœ¨main queueé‡Œæ‰§è¡Œã€‚</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">let</span> completion <span class="operator">=</span> completion &#123; <span class="comment">// æ‰§è¡Œé—­åŒ…å†…å®¹</span></span><br><span class="line">        completion(error: storedError)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  ocä¾‹å­</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dispatchGroupWaitDemo &#123;</span><br><span class="line">  <span class="built_in">dispatch_queue_t</span> concurrentQueue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.concurrentqueue&quot;</span>,DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">  dispatch_group_t group = dispatch_group_create();</span><br><span class="line">  <span class="comment">//åœ¨groupä¸­æ·»åŠ é˜Ÿåˆ—çš„block</span></span><br><span class="line">  dispatch_group_async(group, concurrentQueue, ^&#123;</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2.</span>f];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;1&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  dispatch_group_async(group, concurrentQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;2&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  dispatch_group_wait(group, DISPATCH_TIME_FOREVER);</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;go on&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç¬¬äºŒç§ä½¿ç”¨dispatch_group_notifyçš„<strong>swift</strong>çš„ä¾‹å­ï¼š </li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">downloadPhotosWithCompletion</span>(<span class="params">completion</span>: <span class="type">BatchPhotoDownloadingCompletionClosure</span>?)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸ç”¨åŠ dispatch_asyncï¼Œå› ä¸ºæ²¡æœ‰é˜»å¡ä¸»è¿›ç¨‹</span></span><br><span class="line">  <span class="keyword">var</span> storedError: <span class="type">NSError</span>!</span><br><span class="line">  <span class="keyword">var</span> downloadGroup <span class="operator">=</span> dispatch_group_create()</span><br><span class="line">  <span class="keyword">for</span> address <span class="keyword">in</span> [<span class="type">OverlyAttachedGirlfriendURLString</span>,</span><br><span class="line">                  <span class="type">SuccessKidURLString</span>,</span><br><span class="line">                  <span class="type">LotsOfFacesURLString</span>] &#123;</span><br><span class="line">    <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">NSURL</span>(string: address)</span><br><span class="line">    dispatch_group_enter(downloadGroup)</span><br><span class="line">    <span class="keyword">let</span> photo <span class="operator">=</span> <span class="type">DownloadPhoto</span>(url: url<span class="operator">!</span>) &#123;</span><br><span class="line">      image, error <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">let</span> error <span class="operator">=</span> error &#123;</span><br><span class="line">        storedError <span class="operator">=</span> error</span><br><span class="line">      &#125;</span><br><span class="line">      dispatch_group_leave(downloadGroup)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">PhotoManager</span>.sharedManager.addPhoto(photo)</span><br><span class="line">  &#125;</span><br><span class="line">  dispatch_group_notify(downloadGroup, <span class="type">GlobalMainQueue</span>) &#123;</span><br><span class="line">    <span class="comment">// dispatch_group_notifyå’Œdispatch_group_waitçš„åŒºåˆ«å°±æ˜¯æ˜¯å¼‚æ­¥æ‰§è¡Œé—­åŒ…çš„ï¼Œå½“dispatch groupsä¸­æ²¡æœ‰å‰©ä½™çš„ä»»åŠ¡æ—¶é—­åŒ…æ‰æ‰§è¡Œã€‚è¿™é‡Œæ˜¯æŒ‡æ˜åœ¨ä¸»é˜Ÿåˆ—ä¸­æ‰§è¡Œã€‚</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> completion <span class="operator">=</span> completion &#123;</span><br><span class="line">      completion(error: storedError)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ocä¾‹å­ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//dispatch_group_notify</span></span><br><span class="line">- (<span class="keyword">void</span>)dispatchGroupNotifyDemo &#123;</span><br><span class="line">  <span class="built_in">dispatch_queue_t</span> concurrentQueue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.concurrentqueue&quot;</span>,DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"></span><br><span class="line">  dispatch_group_t group = dispatch_group_create();</span><br><span class="line">  dispatch_group_async(group, concurrentQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;1&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  dispatch_group_async(group, concurrentQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;2&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  dispatch_group_notify(group, dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;end&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;can continue&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//dispatch_group_wait</span></span><br><span class="line">- (<span class="keyword">void</span>)dispatchGroupWaitDemo &#123;</span><br><span class="line">  <span class="built_in">dispatch_queue_t</span> concurrentQueue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.concurrentqueue&quot;</span>,DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">  dispatch_group_t group = dispatch_group_create();</span><br><span class="line">  <span class="comment">//åœ¨groupä¸­æ·»åŠ é˜Ÿåˆ—çš„block</span></span><br><span class="line">  dispatch_group_async(group, concurrentQueue, ^&#123;</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2.</span>f];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;1&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  dispatch_group_async(group, concurrentQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;2&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  dispatch_group_wait(group, DISPATCH_TIME_FOREVER);</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;can continue&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å¦‚ä½•å¯¹ç°æœ‰APIä½¿ç”¨dispatch_group_t </li>
</ol>
<p>ç»™Core Dataçš„-performBlock:æ·»åŠ groupsã€‚ç»„åˆå®Œæˆä»»åŠ¡åä½¿ç”¨dispatch_group_notifyæ¥è¿è¡Œä¸€ä¸ªblockå³å¯ã€‚ </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)withGroup:(dispatch_group_t)group performBlock:(dispatch_block_t)block &#123;</span><br><span class="line">  <span class="keyword">if</span> (group == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    [<span class="keyword">self</span> performBlock:block];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    dispatch_group_enter(group);</span><br><span class="line">    [<span class="keyword">self</span> performBlock:^()&#123;</span><br><span class="line">      block();</span><br><span class="line">      dispatch_group_leave(group);</span><br><span class="line">    &#125;];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NSURLConnectionä¹Ÿå¯ä»¥è¿™æ ·åš</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)withGroup:(dispatch_group_t)group sendAsynchronousRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">            queue:(<span class="built_in">NSOperationQueue</span> *)queue completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span>*, <span class="built_in">NSData</span>*, <span class="built_in">NSError</span>*))handler &#123;</span><br><span class="line">    <span class="keyword">if</span> (group == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        [<span class="keyword">self</span> sendAsynchronousRequest:request queue:queue completionHandler:handler];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dispatch_group_enter(group);</span><br><span class="line">        [<span class="keyword">self</span> sendAsynchronousRequest:request</span><br><span class="line">                                queue:queue</span><br><span class="line">                    completionHandler:^(<span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSData</span> *data, <span class="built_in">NSError</span> *error)&#123;</span><br><span class="line">            handler(response, data, error);</span><br><span class="line">            dispatch_group_leave(group);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>æ³¨æ„äº‹é¡¹ï¼š</code> </p>
<ul>
<li>dispatch_group_async ç­‰ä»·äº dispatch_group_enter() å’Œ dispatch_group_leave() çš„ç»„åˆã€‚ </li>
<li>dispatch_group_enter() å¿…é¡»è¿è¡Œåœ¨ dispatch_group_leave() ä¹‹å‰ã€‚ </li>
<li>dispatch_group_enter() å’Œ dispatch_group_leave() éœ€è¦æˆå¯¹å‡ºç°çš„ </li>
</ul>
<h4 id="ä¸ƒã€Dispatch-Block"><a href="#ä¸ƒã€Dispatch-Block" class="headerlink" title="ä¸ƒã€Dispatch Block"></a>ä¸ƒã€Dispatch Block</h4><p>â€‹    é˜Ÿåˆ—æ‰§è¡Œä»»åŠ¡éƒ½æ˜¯blockçš„æ–¹å¼</p>
<ol>
<li><h5 id="dispatch-block-t-åˆ›å»ºblock"><a href="#dispatch-block-t-åˆ›å»ºblock" class="headerlink" title="dispatch_block_t åˆ›å»ºblock"></a>dispatch_block_t åˆ›å»ºblock</h5></li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)createDispatchBlock &#123;</span><br><span class="line">  <span class="comment">//normal way</span></span><br><span class="line">  <span class="built_in">dispatch_queue_t</span> concurrentQueue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.concurrentqueue&quot;</span>,DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"></span><br><span class="line">  dispatch_block_t block = dispatch_block_create(<span class="number">0</span>, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;run block&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">dispatch_async</span>(concurrentQueue, block);</span><br><span class="line">  <span class="comment">//QOS way</span></span><br><span class="line">  dispatch_block_t qosBlock = dispatch_block_create_with_qos_class(<span class="number">0</span>, QOS_CLASS_USER_INITIATED, <span class="number">-1</span>, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;run qos block&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">dispatch_async</span>(concurrentQueue, qosBlock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><h5 id="dispatch-block-wait"><a href="#dispatch-block-wait" class="headerlink" title="dispatch_block_wait"></a>dispatch_block_wait</h5><p>å¯ä»¥æ ¹æ®dispatch blockæ¥è®¾ç½®ç­‰å¾…æ—¶é—´ï¼Œå‚æ•°DISPATCH_TIME_FOREVERä¼šä¸€ç›´ç­‰å¾…blockç»“æŸ </p>
</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dispatchBlockWaitDemo &#123; </span><br><span class="line"><span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.serialqueue&quot;</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">dispatch_block_t block = dispatch_block_create(<span class="number">0</span>, ^&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;star&quot;</span>);</span><br><span class="line">  [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5.</span>f];</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;end&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(serialQueue, block);</span><br><span class="line"><span class="comment">//è®¾ç½®DISPATCH_TIME_FOREVERä¼šä¸€ç›´ç­‰åˆ°å‰é¢ä»»åŠ¡éƒ½å®Œæˆ</span></span><br><span class="line">dispatch_block_wait(block, DISPATCH_TIME_FOREVER);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;ok, now can go on&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><h5 id="dispatch-block-notify"><a href="#dispatch-block-notify" class="headerlink" title="dispatch_block_notify"></a>dispatch_block_notify</h5><p>å¯ä»¥ç›‘è§†æŒ‡å®šdispatch blockç»“æŸï¼Œç„¶åå†åŠ å…¥ä¸€ä¸ªblockåˆ°é˜Ÿåˆ—ä¸­ã€‚ </p>
<p>ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸ºï¼Œç¬¬ä¸€ä¸ªæ˜¯éœ€è¦ç›‘è§†çš„blockï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯éœ€è¦æäº¤æ‰§è¡Œçš„é˜Ÿåˆ—ï¼Œç¬¬ä¸‰ä¸ªæ˜¯å¾…åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­çš„block </p>
</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dispatchBlockNotifyDemo &#123;</span><br><span class="line">  <span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.serialqueue&quot;</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">  dispatch_block_t firstBlock = dispatch_block_create(<span class="number">0</span>, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;first block start&quot;</span>);</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2.</span>f];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;first block end&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">dispatch_async</span>(serialQueue, firstBlock);</span><br><span class="line">  dispatch_block_t secondBlock = dispatch_block_create(<span class="number">0</span>, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;second block run&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">//first blockæ‰§è¡Œå®Œæ‰åœ¨serial queueä¸­æ‰§è¡Œsecond block</span></span><br><span class="line">  dispatch_block_notify(firstBlock, serialQueue, secondBlock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><h5 id="dispatch-block-cancel"><a href="#dispatch-block-cancel" class="headerlink" title="dispatch_block_cancel"></a>dispatch_block_cancel</h5><p>iOS8åGCDæ”¯æŒå¯¹dispatch blockçš„å–æ¶ˆ </p>
</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dispatchBlockCancelDemo &#123;</span><br><span class="line">  <span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.serialqueue&quot;</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">  dispatch_block_t firstBlock = dispatch_block_create(<span class="number">0</span>, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;first block start&quot;</span>);</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2.</span>f];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;first block end&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  dispatch_block_t secondBlock = dispatch_block_create(<span class="number">0</span>, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;second block run&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">dispatch_async</span>(serialQueue, firstBlock);</span><br><span class="line">  <span class="built_in">dispatch_async</span>(serialQueue, secondBlock);</span><br><span class="line">  <span class="comment">//å–æ¶ˆsecondBlock</span></span><br><span class="line">  dispatch_block_cancel(secondBlock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><h5 id="ä½¿ç”¨dispatch-block-objectï¼ˆè°ƒåº¦å—ï¼‰åœ¨ä»»åŠ¡æ‰§è¡Œå‰è¿›è¡Œå–æ¶ˆ"><a href="#ä½¿ç”¨dispatch-block-objectï¼ˆè°ƒåº¦å—ï¼‰åœ¨ä»»åŠ¡æ‰§è¡Œå‰è¿›è¡Œå–æ¶ˆ" class="headerlink" title="ä½¿ç”¨dispatch block objectï¼ˆè°ƒåº¦å—ï¼‰åœ¨ä»»åŠ¡æ‰§è¡Œå‰è¿›è¡Œå–æ¶ˆ"></a>ä½¿ç”¨dispatch block objectï¼ˆè°ƒåº¦å—ï¼‰åœ¨ä»»åŠ¡æ‰§è¡Œå‰è¿›è¡Œå–æ¶ˆ</h5><p>dispatch block objectå¯ä»¥ä¸ºé˜Ÿåˆ—ä¸­çš„å¯¹è±¡è®¾ç½® </p>
<p>ç¤ºä¾‹ï¼Œä¸‹è½½å›¾ç‰‡ä¸­é€”è¿›è¡Œå–æ¶ˆ </p>
</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">downloadPhotosWithCompletion</span>(<span class="params">completion</span>: <span class="type">BatchPhotoDownloadingCompletionClosure</span>?)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> storedError: <span class="type">NSError</span>!</span><br><span class="line">  <span class="keyword">let</span> downloadGroup <span class="operator">=</span> dispatch_group_create()</span><br><span class="line">  <span class="keyword">var</span> addresses <span class="operator">=</span> [<span class="type">OverlyAttachedGirlfriendURLString</span>,</span><br><span class="line">                   <span class="type">SuccessKidURLString</span>,</span><br><span class="line">                   <span class="type">LotsOfFacesURLString</span>]</span><br><span class="line">  addresses <span class="operator">+=</span> addresses <span class="operator">+</span> addresses <span class="comment">// æ‰©å±•addressæ•°ç»„ï¼Œå¤åˆ¶3ä»½</span></span><br><span class="line">  <span class="keyword">var</span> blocks: [dispatch_block_t] <span class="operator">=</span> [] <span class="comment">// ä¸€ä¸ªä¿å­˜blockçš„æ•°ç»„</span></span><br><span class="line"> 	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> <span class="operator">..&lt;</span> addresses.count &#123;</span><br><span class="line">    dispatch_group_enter(downloadGroup)</span><br><span class="line">    <span class="keyword">let</span> block <span class="operator">=</span> dispatch_block_create(<span class="type">DISPATCH_BLOCK_INHERIT_QOS_CLASS</span>) &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»ºä¸€ä¸ªblockï¼Œblockçš„æ ‡å¿—æ˜¯DISPATCH_BLOCK_INHERIT_QOS_CLASS</span></span><br><span class="line">      <span class="keyword">let</span> index <span class="operator">=</span> <span class="type">Int</span>(i)</span><br><span class="line">      <span class="keyword">let</span> address <span class="operator">=</span> addresses[index]</span><br><span class="line">      <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">NSURL</span>(string: address)</span><br><span class="line">      <span class="keyword">let</span> photo <span class="operator">=</span> <span class="type">DownloadPhoto</span>(url: url<span class="operator">!</span>) &#123;</span><br><span class="line">        image, error <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> error <span class="operator">=</span> error &#123;</span><br><span class="line">          storedError <span class="operator">=</span> error</span><br><span class="line">        &#125;</span><br><span class="line">        dispatch_group_leave(downloadGroup)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">PhotoManager</span>.sharedManager.addPhoto(photo)</span><br><span class="line">    &#125;</span><br><span class="line">    blocks.append(block)</span><br><span class="line">    dispatch_async(<span class="type">GlobalMainQueue</span>, block)</span><br><span class="line">    <span class="comment">// æŠŠè¿™ä¸ªblockæ”¾åˆ°GlobalMainQueueä¸Šå¼‚æ­¥è°ƒç”¨ã€‚å› ä¸ºå…¨å±€é˜Ÿåˆ—æ˜¯ä¸€ä¸ªé¡ºåºé˜Ÿåˆ—æ‰€ä»¥æ–¹ä¾¿å–æ¶ˆå¯¹è±¡blockï¼ŒåŒæ—¶å¯ä»¥ä¿è¯ä¸‹è½½ä»»åŠ¡åœ¨downloadPhotosWithCompletionè¿”å›åæ‰å¼€å§‹æ‰§è¡Œã€‚</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> block <span class="keyword">in</span> blocks[<span class="number">3</span> <span class="operator">..&lt;</span> blocks.count] &#123;</span><br><span class="line">    <span class="keyword">let</span> cancel <span class="operator">=</span> arc4random_uniform(<span class="number">2</span>) <span class="comment">// éšæœºè¿”å›ä¸€ä¸ªæ•´æ•°ï¼Œä¼šè¿”å›0æˆ–1</span></span><br><span class="line">    <span class="keyword">if</span> cancel <span class="operator">==</span> <span class="number">1</span> &#123;</span><br><span class="line">      dispatch_block_cancel(block)</span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯1å°±å–æ¶ˆblockï¼Œè¿™ä¸ªåªèƒ½å‘ç”Ÿåœ¨blockè¿˜åœ¨é˜Ÿåˆ—ä¸­å¹¶æ²¡æœ‰å¼€å§‹çš„æƒ…å†µä¸‹ã€‚å› ä¸ºæŠŠblockå·²ç»æ”¾åˆ°äº†GlobalMainQueueä¸­ï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹ä¼šå…ˆæ‰§è¡Œï¼Œæ‰§è¡Œå®Œäº†æ‰ä¼šæ‰§è¡Œblockã€‚</span></span><br><span class="line">      <span class="comment">// å› ä¸ºå·²ç»dispatch_group_enteräº†ï¼Œæ‰€ä»¥å–æ¶ˆæ—¶ä¹Ÿè¦å°†å…¶éƒ½leaveæ‰ã€‚</span></span><br><span class="line">      dispatch_group_leave(downloadGroup)       </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  dispatch_group_notify(downloadGroup, <span class="type">GlobalMainQueue</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> completion <span class="operator">=</span> completion &#123;</span><br><span class="line">      completion(error: storedError)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å…«ã€Dispatch-IO-æ–‡ä»¶æ“ä½œ"><a href="#å…«ã€Dispatch-IO-æ–‡ä»¶æ“ä½œ" class="headerlink" title="å…«ã€Dispatch IO æ–‡ä»¶æ“ä½œ"></a>å…«ã€Dispatch IO æ–‡ä»¶æ“ä½œ</h4><p>dispatch ioè¯»å–æ–‡ä»¶çš„æ–¹å¼ç±»ä¼¼äºä¸‹é¢çš„æ–¹å¼ï¼Œå¤šä¸ªçº¿ç¨‹å»è¯»å–æ–‡ä»¶çš„åˆ‡ç‰‡æ•°æ®ï¼Œå¯¹äºå¤§çš„æ•°æ®æ–‡ä»¶è¿™æ ·ä¼šæ¯”å•çº¿ç¨‹è¦å¿«å¾ˆå¤šã€‚ </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_async</span>(queue,^&#123;<span class="comment">/*read 0-99 bytes*/</span>&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue,^&#123;<span class="comment">/*read 100-199 bytes*/</span>&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue,^&#123;<span class="comment">/*read 200-299 bytes*/</span>&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>dispatch_io_createï¼šåˆ›å»ºdispatch io ã€‚</li>
<li>dispatch_io_set_low_waterï¼šæŒ‡å®šåˆ‡å‰²æ–‡ä»¶å¤§å° ã€‚</li>
<li>dispatch_io_readï¼šè¯»å–åˆ‡å‰²çš„æ–‡ä»¶ç„¶ååˆå¹¶ã€‚ </li>
</ul>
<blockquote>
<p>è‹¹æœç³»ç»Ÿæ—¥å¿—APIé‡Œç”¨åˆ°äº†è¿™ä¸ªæŠ€æœ¯ï¼Œå¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ï¼š </p>
<p><a target="_blank" rel="noopener" href="https://github.com/Apple-FOSS-Mirror/Libc/blob/2ca2ae74647714acfc18674c3114b1a5d3325d7d/gen/asl.c">https://github.com/Apple-FOSS-Mirror/Libc/blob/2ca2ae74647714acfc18674c3114b1a5d3325d7d/gen/asl.c</a></p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pipe_q = dispatch_queue_create(<span class="string">&quot;PipeQ&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">//åˆ›å»º</span></span><br><span class="line">pipe_channel = dispatch_io_create(DISPATCH_IO_STREAM, fd, pipe_q, ^(<span class="keyword">int</span> err)&#123;</span><br><span class="line">  close(fd);</span><br><span class="line">&#125;);</span><br><span class="line">*out_fd = fdpair[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®åˆ‡å‰²å¤§å°</span></span><br><span class="line">dispatch_io_set_low_water(pipe_channel, SIZE_MAX);</span><br><span class="line">dispatch_io_read(pipe_channel, <span class="number">0</span>, SIZE_MAX, pipe_q, ^(<span class="keyword">bool</span> done, dispatch_data_t pipedata, <span class="keyword">int</span> err) &#123;</span><br><span class="line">  <span class="keyword">if</span> (err == <span class="number">0</span>) &#123;</span><br><span class="line">    size_t len = dispatch_data_get_size(pipedata);</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">//å¯¹æ¯æ¬¡åˆ‡å—æ•°æ®çš„å¤„ç†</span></span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">char</span> *bytes = <span class="literal">NULL</span>;</span><br><span class="line">      <span class="keyword">char</span> *encoded;</span><br><span class="line">      uint32_t eval;</span><br><span class="line">      dispatch_data_t md = dispatch_data_create_map(pipedata, </span><br><span class="line">                                                    (<span class="keyword">const</span> <span class="keyword">void</span> **)&amp;bytes, </span><br><span class="line">                                                    &amp;len);</span><br><span class="line">      encoded = asl_core_encode_buffer(bytes, len);</span><br><span class="line">      asl_msg_set_key_val(aux, ASL_KEY_AUX_DATA, encoded);</span><br><span class="line">      free(encoded);</span><br><span class="line">      eval = _asl_evaluate_send(<span class="literal">NULL</span>, (aslmsg)aux, <span class="number">-1</span>);</span><br><span class="line">      _asl_send_message(<span class="literal">NULL</span>, eval, aux, <span class="literal">NULL</span>);</span><br><span class="line">      asl_msg_release(aux);</span><br><span class="line">      dispatch_release(md);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (done) &#123;</span><br><span class="line">    <span class="comment">//semaphore +1ä½¿å¾—ä¸éœ€è¦å†ç­‰å¾…ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚</span></span><br><span class="line">    dispatch_semaphore_signal(sem);</span><br><span class="line">    dispatch_release(pipe_channel);</span><br><span class="line">    dispatch_release(pipe_q);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h4 id="ä¹ã€Dispatch-Source-ç”¨GCDç›‘è§†è¿›ç¨‹"><a href="#ä¹ã€Dispatch-Source-ç”¨GCDç›‘è§†è¿›ç¨‹" class="headerlink" title="ä¹ã€Dispatch Source ç”¨GCDç›‘è§†è¿›ç¨‹"></a>ä¹ã€Dispatch Source ç”¨GCDç›‘è§†è¿›ç¨‹</h4><p>Dispatch Sourceç”¨äºç›‘å¬ç³»ç»Ÿçš„åº•å±‚å¯¹è±¡ï¼Œæ¯”å¦‚æ–‡ä»¶æè¿°ç¬¦ï¼ŒMachç«¯å£ï¼Œä¿¡å·é‡ç­‰ã€‚ä¸»è¦å¤„ç†çš„äº‹ä»¶å¦‚ä¸‹è¡¨ </p>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•</th>
<th align="center">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">DISPATCH_SOURCE_TYPE_DATA_ADD</td>
<td align="center">æ•°æ®å¢åŠ </td>
</tr>
<tr>
<td align="center">DISPATCH_SOURCE_TYPE_DATA_OR</td>
<td align="center">æ•°æ®OR</td>
</tr>
<tr>
<td align="center">DISPATCH_SOURCE_TYPE_MACH_SEND</td>
<td align="center">Machç«¯å£å‘é€</td>
</tr>
<tr>
<td align="center">DISPATCH_SOURCE_TYPE_MACH_RECV</td>
<td align="center">Machç«¯å£æ¥æ”¶</td>
</tr>
<tr>
<td align="center">DISPATCH_SOURCE_TYPE_MEMORYPRESSURE</td>
<td align="center">å†…å­˜æƒ…å†µ</td>
</tr>
<tr>
<td align="center">DISPATCH_SOURCE_TYPE_PROC</td>
<td align="center">è¿›ç¨‹äº‹ä»¶</td>
</tr>
<tr>
<td align="center">DISPATCH_SOURCE_TYPE_READ</td>
<td align="center">è¯»æ•°æ®</td>
</tr>
<tr>
<td align="center">DISPATCH_SOURCE_TYPE_SIGNAL</td>
<td align="center">ä¿¡å·</td>
</tr>
<tr>
<td align="center">DISPATCH_SOURCE_TYPE_TIMER</td>
<td align="center">å®šæ—¶å™¨</td>
</tr>
<tr>
<td align="center">DISPATCH_SOURCE_TYPE_VNODE</td>
<td align="center">æ–‡ä»¶ç³»ç»Ÿå˜åŒ–</td>
</tr>
<tr>
<td align="center">DISPATCH_SOURCE_TYPE_WRITE</td>
<td align="center">æ–‡ä»¶å†™å…¥</td>
</tr>
</tbody></table>
<p>æ–¹æ³• </p>
<ul>
<li>dispatch_source_createï¼šåˆ›å»º dispatch source ï¼Œåˆ›å»ºåä¼šå¤„äºæŒ‚èµ·çŠ¶æ€è¿›è¡Œäº‹ä»¶æ¥æ”¶ï¼Œéœ€è¦è®¾ç½®äº‹ä»¶å¤„ç†handlerè¿›è¡Œäº‹ä»¶å¤„ç†ã€‚ </li>
<li>dispatch_source_set_event_handlerï¼šè®¾ç½®äº‹ä»¶å¤„ç† handler </li>
<li>dispatch_source_set_cancel_handlerï¼šäº‹ä»¶å–æ¶ˆhandlerï¼Œå°±æ˜¯åœ¨ dispatch source é‡Šæ”¾å‰åšäº›æ¸…ç†çš„äº‹ã€‚ </li>
<li>dispatch_source_cancelï¼šå…³é—­ dispatch sourceï¼Œè®¾ç½®çš„äº‹ä»¶å¤„ç† handler ä¸ä¼šè¢«æ‰§è¡Œï¼Œå·²ç»æ‰§è¡Œçš„äº‹ä»¶handlerä¸ä¼šå–æ¶ˆã€‚ </li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSRunningApplication</span> *mail = [<span class="built_in">NSRunningApplication</span> runningApplicationsWithBundleIdentifier:<span class="string">@&quot;com.apple.mail&quot;</span>];</span><br><span class="line"><span class="keyword">if</span> (mail == <span class="literal">nil</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pid_t <span class="keyword">const</span> pid = mail.processIdentifier;</span><br><span class="line"><span class="keyword">self</span>.source = dispatch_source_create(DISPATCH_SOURCE_TYPE_PROC, pid, </span><br><span class="line">                                     DISPATCH_PROC_EXIT, </span><br><span class="line">                                     DISPATCH_TARGET_QUEUE_DEFAULT);</span><br><span class="line">dispatch_source_set_event_handler(<span class="keyword">self</span>.source, ^()&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;Mail quit.&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨äº‹ä»¶æºä¼ åˆ°ä½ çš„äº‹ä»¶å¤„ç†å‰éœ€è¦è°ƒç”¨dispatch_resume()è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line">dispatch_resume(<span class="keyword">self</span>.source);</span><br></pre></td></tr></table></figure>



<p>ç›‘è§†æ–‡ä»¶å¤¹å†…æ–‡ä»¶å˜åŒ– </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSURL</span> *directoryURL; <span class="comment">// assume this is set to a directory</span></span><br><span class="line"><span class="keyword">int</span> <span class="keyword">const</span> fd = open([[directoryURL path] fileSystemRepresentation], O_EVTONLY);</span><br><span class="line"><span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="keyword">char</span> buffer[<span class="number">80</span>];</span><br><span class="line">	strerror_r(errno, buffer, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@&quot;Unable to open &quot;</span>%<span class="string">@&quot;: %s (%d)&quot;</span>, [directoryURL path], buffer, errno);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dispatch_source_t source = dispatch_source_create(DISPATCH_SOURCE_TYPE_VNODE, </span><br><span class="line">                                                  fd,</span><br><span class="line">                                                  DISPATCH_VNODE_WRITE | </span><br><span class="line">                                                  DISPATCH_VNODE_DELETE, </span><br><span class="line">                                                  DISPATCH_TARGET_QUEUE_DEFAULT);</span><br><span class="line"></span><br><span class="line">dispatch_source_set_event_handler(source, ^()&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">const</span> data = dispatch_source_get_data(source);</span><br><span class="line">	<span class="keyword">if</span> (data &amp; DISPATCH_VNODE_WRITE) &#123;</span><br><span class="line">		<span class="built_in">NSLog</span>(<span class="string">@&quot;The directory changed.&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (data &amp; DISPATCH_VNODE_DELETE) &#123;</span><br><span class="line">		<span class="built_in">NSLog</span>(<span class="string">@&quot;The directory has been deleted.&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_source_set_cancel_handler(source, ^()&#123;</span><br><span class="line">	close(fd);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.source = source;</span><br><span class="line">dispatch_resume(<span class="keyword">self</span>.source);</span><br></pre></td></tr></table></figure>

<p><strong>è¿˜è¦æ³¨æ„éœ€è¦ç”¨DISPATCH_VNODE_DELETE å»æ£€æŸ¥ç›‘è§†çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹æ˜¯å¦è¢«åˆ é™¤ï¼Œå¦‚æœåˆ é™¤äº†å°±åœæ­¢ç›‘å¬</strong></p>
<p>NSTimeråœ¨ä¸»çº¿ç¨‹çš„runloopé‡Œä¼šåœ¨runloopåˆ‡æ¢å…¶å®ƒæ¨¡å¼æ—¶åœæ­¢ï¼Œè¿™æ—¶å°±éœ€è¦æ‰‹åŠ¨åœ¨å­çº¿ç¨‹å¼€å¯ä¸€ä¸ªæ¨¡å¼ä¸º NSRunLoopCommonModesçš„runloopï¼Œ å¦‚æœä¸æƒ³å¼€å¯ä¸€ä¸ªæ–°çš„runloopå¯ä»¥ç”¨ä¸è·Ÿrunloopå…³è”çš„dispatch source timerï¼Œå¦‚ä¸‹ã€‚ </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">dispatch_source_t source = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER,</span><br><span class="line">                                                  <span class="number">0</span>, </span><br><span class="line">                                                  <span class="number">0</span>, </span><br><span class="line">                                                  DISPATCH_TARGET_QUEUE_DEFAULT);</span><br><span class="line"></span><br><span class="line">dispatch_source_set_event_handler(source, ^()&#123;</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@&quot;Time flies.&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">dispatch_time_t start</span><br><span class="line">dispatch_source_set_timer(source, </span><br><span class="line">                          DISPATCH_TIME_NOW, </span><br><span class="line">                          <span class="number">5</span>ull * <span class="built_in">NSEC_PER_SEC</span>,</span><br><span class="line">                          <span class="number">100</span>ull * <span class="built_in">NSEC_PER_MSEC</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.source = source;</span><br><span class="line">dispatch_resume(<span class="keyword">self</span>.source);</span><br></pre></td></tr></table></figure>



<h4 id="åã€Dispatch-Semaphoreå’Œçš„ä»‹ç»"><a href="#åã€Dispatch-Semaphoreå’Œçš„ä»‹ç»" class="headerlink" title="åã€Dispatch Semaphoreå’Œçš„ä»‹ç»"></a>åã€Dispatch Semaphoreå’Œçš„ä»‹ç»</h4><p>å¦å¤–ä¸€ç§ä¿è¯åŒæ­¥çš„æ–¹æ³•ã€‚ä½¿ç”¨ dispatch_semaphore_signal åŠ 1 dispatch_semaphore_wait å‡1ï¼Œä¸º0æ—¶ç­‰å¾…çš„è®¾ç½®æ–¹å¼æ¥è¾¾åˆ°çº¿ç¨‹åŒæ­¥çš„ç›®çš„å’Œ åŒæ­¥é”ä¸€æ ·èƒ½å¤Ÿè§£å†³èµ„æºæŠ¢å çš„é—®é¢˜ã€‚ </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//dispatch semaphore</span></span><br><span class="line">- (<span class="keyword">void</span>)dispatchSemaphoreDemo &#123;</span><br><span class="line">  <span class="comment">//åˆ›å»ºsemaphore</span></span><br><span class="line">	dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@&quot;start&quot;</span>);</span><br><span class="line">	[<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1.</span>f];</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@&quot;semaphore +1&quot;</span>);</span><br><span class="line">	dispatch_semaphore_signal(semaphore); <span class="comment">//+1 semaphore</span></span><br><span class="line">    </span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@&quot;continue&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="åä¸€ã€é”"><a href="#åä¸€ã€é”" class="headerlink" title="åä¸€ã€é”"></a>åä¸€ã€é”</h4><p>è¿™é‡Œç®€å•ä»‹ç»ä¸‹iOSä¸­å¸¸ç”¨çš„å„ç§é”å’Œä»–ä»¬çš„æ€§èƒ½ã€‚ </p>
<ul>
<li>NSRecursiveLockï¼šé€’å½’é”ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­åå¤è·å–é”ä¸ä¼šé€ æˆæ­»é”ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šè®°å½•è·å–é”å’Œé‡Šæ”¾é”çš„æ¬¡æ•°æ¥è¾¾åˆ°ä½•æ—¶é‡Šæ”¾çš„ä½œç”¨ã€‚ </li>
<li>NSDistributedLockï¼šåˆ†å¸ƒé”ï¼ŒåŸºäºæ–‡ä»¶æ–¹å¼çš„é”æœºåˆ¶ï¼Œå¯ä»¥è·¨è¿›ç¨‹è®¿é—®ã€‚ </li>
<li>NSConditionLockï¼šæ¡ä»¶é”ï¼Œç”¨æˆ·å®šä¹‰æ¡ä»¶ï¼Œç¡®ä¿ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–æ»¡è¶³ä¸€å®šæ¡ä»¶çš„é”ã€‚ å› ä¸ºçº¿ç¨‹é—´ç«äº‰ä¼šæ¶‰åŠåˆ°æ¡ä»¶é”æ£€æµ‹ï¼Œç³»ç»Ÿè°ƒç”¨ä¸Šä¸‹åˆ‡æ¢é¢‘ç¹å¯¼è‡´è€—æ—¶æ˜¯å‡ ä¸ªé”é‡Œæœ€é•¿çš„ã€‚ </li>
<li>OSSpinLockï¼šè‡ªæ—‹é”ï¼Œä¸è¿›å…¥å†…æ ¸ï¼Œå‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ€§èƒ½æœ€é«˜ï¼Œä½†æŠ¢å å¤šæ—¶ä¼šå ç”¨è¾ƒå¤šcpuï¼Œå¥½ç‚¹å¤šï¼Œè¿™æ—¶ä½¿ç”¨pthread_mutexè¾ƒå¥½ã€‚ </li>
<li>pthread_mutex_tï¼šåŒæ­¥é”åŸºäºCè¯­è¨€ï¼Œåº•å±‚apiæ€§èƒ½é«˜ï¼Œä½¿ç”¨æ–¹æ³•å’Œå…¶å®ƒçš„ç±»ä¼¼ã€‚ </li>
<li>@synchronizedï¼šæ›´åŠ ç®€å•ã€‚ </li>
</ul>
<h4 id="åäºŒã€dispatch-suspendå’Œdispatch-resumeæŒ‚èµ·å’Œæ¢å¤é˜Ÿåˆ—"><a href="#åäºŒã€dispatch-suspendå’Œdispatch-resumeæŒ‚èµ·å’Œæ¢å¤é˜Ÿåˆ—" class="headerlink" title="åäºŒã€dispatch_suspendå’Œdispatch_resumeæŒ‚èµ·å’Œæ¢å¤é˜Ÿåˆ—"></a>åäºŒã€dispatch_suspendå’Œdispatch_resumeæŒ‚èµ·å’Œæ¢å¤é˜Ÿåˆ—</h4><p>dispatch_suspendè¿™é‡ŒæŒ‚èµ·ä¸ä¼šæš‚åœæ­£åœ¨æ‰§è¡Œçš„blockï¼Œåªæ˜¯èƒ½å¤Ÿæš‚åœè¿˜æ²¡æ‰§è¡Œçš„blockã€‚ </p>
<h4 id="åä¸‰ã€dispatch-set-contextå’Œdispatch-get-context"><a href="#åä¸‰ã€dispatch-set-contextå’Œdispatch-get-context" class="headerlink" title="åä¸‰ã€dispatch_set_contextå’Œdispatch_get_context"></a>åä¸‰ã€dispatch_set_contextå’Œdispatch_get_context</h4><p>?</p>
<h2 id="GCDæ·±å…¥æ“ä½œ"><a href="#GCDæ·±å…¥æ“ä½œ" class="headerlink" title="GCDæ·±å…¥æ“ä½œ"></a>GCDæ·±å…¥æ“ä½œ</h2><ul>
<li>ç¼“å†²åŒºï¼šdispatch_data_t åŸºäºé›¶ç¢çš„å†…å­˜åŒºåŸŸï¼Œä½¿ç”¨ dispatch_data_apply æ¥éå†ï¼Œè¿˜å¯ä»¥ç”¨ dispatch_data_create_subrange æ¥åˆ›å»ºä¸€ä¸ªä¸åšä»»ä½•æ‹·è´çš„å­åŒºåŸŸ </li>
<li>I/Oè°ƒåº¦ï¼šä½¿ç”¨GCDæä¾›çš„dispatch_io_readï¼Œdispatch_io_writeå’Œdispatch_io_close </li>
<li>æµ‹è¯•ï¼šä½¿ç”¨ dispatch_benchmark å°å·¥å…· </li>
<li>åŸå­æ“ä½œï¼š libkern/OSAtomic.h é‡Œå¯ä»¥æŸ¥çœ‹é‚£äº›å‡½æ•°ï¼Œç”¨äºåº•å±‚å¤šçº¿ç¨‹ç¼–ç¨‹ã€‚ </li>
</ul>
<h3 id="GCDæ­»é”"><a href="#GCDæ­»é”" class="headerlink" title="GCDæ­»é”"></a>GCDæ­»é”</h3><p>ä¸²è¡Œé˜Ÿåˆ—é‡Œé¢åŒæ­¥ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—å°±ä¼šæ­»é”ï¼Œè§£å†³çš„æ–¹æ³•å°±æ˜¯å°†åŒæ­¥çš„ä¸²è¡Œé˜Ÿåˆ—æ”¾åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹å°±èƒ½å¤Ÿè§£å†³ã€‚ </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)deadLockCase1 &#123;</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@&quot;1&quot;</span>);</span><br><span class="line">	<span class="comment">//ä¸»é˜Ÿåˆ—çš„åŒæ­¥çº¿ç¨‹ï¼ŒæŒ‰ç…§FIFOçš„åŸåˆ™ï¼ˆå…ˆå…¥å…ˆå‡ºï¼‰ï¼Œ2æ’åœ¨3åé¢ä¼šç­‰3æ‰§è¡Œå®Œï¼Œä½†å› ä¸ºåŒæ­¥çº¿ç¨‹ï¼Œ3åˆè¦ç­‰2æ‰§è¡Œå®Œï¼Œç›¸äº’ç­‰å¾…æˆä¸ºæ­»é”ã€‚</span></span><br><span class="line">	<span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">		<span class="built_in">NSLog</span>(<span class="string">@&quot;2&quot;</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@&quot;3&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)deadLockCase2 &#123;</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@&quot;1&quot;</span>);</span><br><span class="line">	<span class="comment">//3ä¼šç­‰2ï¼Œå› ä¸º2åœ¨å…¨å±€å¹¶è¡Œé˜Ÿåˆ—é‡Œï¼Œä¸éœ€è¦ç­‰å¾…3ï¼Œè¿™æ ·2æ‰§è¡Œå®Œå›åˆ°ä¸»é˜Ÿåˆ—ï¼Œ3å°±å¼€å§‹æ‰§è¡Œ</span></span><br><span class="line">	<span class="built_in">dispatch_sync</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, <span class="number">0</span>), ^&#123;</span><br><span class="line">		<span class="built_in">NSLog</span>(<span class="string">@&quot;2&quot;</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@&quot;3&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)deadLockCase3 &#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">&quot;com.starming.gcddemo.serialqueue&quot;</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;1&quot;</span>);</span><br><span class="line">	<span class="built_in">dispatch_async</span>(serialQueue, ^&#123;</span><br><span class="line">		<span class="built_in">NSLog</span>(<span class="string">@&quot;2&quot;</span>);</span><br><span class="line">			<span class="comment">//ä¸²è¡Œé˜Ÿåˆ—é‡Œé¢åŒæ­¥ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—å°±ä¼šæ­»é”</span></span><br><span class="line">		<span class="built_in">dispatch_sync</span>(serialQueue, ^&#123;</span><br><span class="line">			<span class="built_in">NSLog</span>(<span class="string">@&quot;3&quot;</span>);</span><br><span class="line">		&#125;);</span><br><span class="line">		<span class="built_in">NSLog</span>(<span class="string">@&quot;4&quot;</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@&quot;5&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)deadLockCase4 &#123;</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@&quot;1&quot;</span>);</span><br><span class="line">	<span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">		<span class="built_in">NSLog</span>(<span class="string">@&quot;2&quot;</span>);</span><br><span class="line">		<span class="comment">//å°†åŒæ­¥çš„ä¸²è¡Œé˜Ÿåˆ—æ”¾åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹å°±èƒ½å¤Ÿè§£å†³</span></span><br><span class="line">		<span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">			<span class="built_in">NSLog</span>(<span class="string">@&quot;3&quot;</span>);</span><br><span class="line">		&#125;);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;4&quot;</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@&quot;5&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)deadLockCase5 &#123;</span><br><span class="line">	<span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">		<span class="built_in">NSLog</span>(<span class="string">@&quot;1&quot;</span>);</span><br><span class="line">		<span class="comment">//å›åˆ°ä¸»çº¿ç¨‹å‘ç°æ­»å¾ªç¯åé¢å°±æ²¡æ³•æ‰§è¡Œäº†</span></span><br><span class="line">		<span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">			<span class="built_in">NSLog</span>(<span class="string">@&quot;2&quot;</span>);</span><br><span class="line">		&#125;);</span><br><span class="line">		<span class="built_in">NSLog</span>(<span class="string">@&quot;3&quot;</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@&quot;4&quot;</span>);</span><br><span class="line">	<span class="comment">//æ­»å¾ªç¯</span></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="GCDå®é™…ä½¿ç”¨"><a href="#GCDå®é™…ä½¿ç”¨" class="headerlink" title="GCDå®é™…ä½¿ç”¨"></a>GCDå®é™…ä½¿ç”¨</h3><p>FMDBå¦‚ä½•ä½¿ç”¨ <strong>dispatch_queue_set_specific</strong> å’Œ <strong>dispatch_get_specific</strong> æ¥é˜²æ­¢æ­»é”ï¼Œä½œç”¨ç±»ä¼¼objc_setAssociatedObjectè·Ÿobjc_getAssociatedObject </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">void</span> * <span class="keyword">const</span> kDispatchQueueSpecificKey = &amp;kDispatchQueueSpecificKey;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—ï¼Œæ‰€æœ‰æ•°æ®åº“çš„æ“ä½œéƒ½åœ¨è¿™ä¸ªé˜Ÿåˆ—é‡Œ</span></span><br><span class="line">_queue = dispatch_queue_create([[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;fmdb.%@&quot;</span>, <span class="keyword">self</span>] UTF8String],</span><br><span class="line">                               <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ ‡è®°é˜Ÿåˆ—</span></span><br><span class="line">dispatch_queue_set_specific(_queue, kDispatchQueueSpecificKey, (__bridge <span class="keyword">void</span> *)<span class="keyword">self</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€ä¸ªé˜Ÿåˆ—æ¥é¿å…æ­»é”çš„æ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)inDatabase:(<span class="keyword">void</span> (^)(FMDatabase *db))block &#123;</span><br><span class="line">	 FMDatabaseQueue *currentSyncQueue = (__bridge <span class="keyword">id</span>)dispatch_get_specific(kDispatchQueueSpecificKey);</span><br><span class="line">	assert(currentSyncQueue != <span class="keyword">self</span> &amp;&amp; <span class="string">&quot;inDatabase: was called reentrantly on the same queue,which would lead to a deadlock&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="iOSç³»ç»Ÿç‰ˆæœ¬æ–°ç‰¹æ€§"><a href="#iOSç³»ç»Ÿç‰ˆæœ¬æ–°ç‰¹æ€§" class="headerlink" title="iOSç³»ç»Ÿç‰ˆæœ¬æ–°ç‰¹æ€§"></a>iOSç³»ç»Ÿç‰ˆæœ¬æ–°ç‰¹æ€§</h2><h3 id="iOS8"><a href="#iOS8" class="headerlink" title="iOS8"></a>iOS8</h3><p>iOS8 æ–°åŠ äº†ä¸€ä¸ªåŠŸèƒ½å« Quality of Service(QoS)ï¼Œé‡Œé¢æä¾›äº†ä¸€ä¸‹å‡ ä¸ªæ›´å®¹æ˜“ç†è§£çš„æšä¸¾åæ¥ä½¿ç”¨user interactiveï¼Œuser initiatedï¼Œutilityå’Œbackgroundã€‚ä¸‹é¢çš„è¡¨åšäº†å¯¹æ¯” </p>
<table>
<thead>
<tr>
<th align="center">Global queue</th>
<th align="center">Corresponding QoS class</th>
<th align="center">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Main thread</td>
<td align="center">NSQualityOfServiceUserInteractive</td>
<td align="center">UIç›¸å…³ï¼Œäº¤äº’ç­‰ã€‚</td>
</tr>
<tr>
<td align="center">DISPATCH_QUEUE_PRIORITY_HIGH</td>
<td align="center">NSQualityOfServiceUserInitiated</td>
<td align="center">ç”¨æˆ·å‘èµ·éœ€è¦é©¬ä¸Šå¾—åˆ°ç»“æœè¿›è¡Œåç»­ä»»åŠ¡ã€‚</td>
</tr>
<tr>
<td align="center">DISPATCH_QUEUE_PRIORITY_DEFAULT</td>
<td align="center">NSQualityOfServiceDefault</td>
<td align="center">é»˜è®¤çš„ä¸åº”è¯¥ä½¿ç”¨è¿™ä¸ªè®¾ç½®ä»»åŠ¡ã€‚</td>
</tr>
<tr>
<td align="center">DISPATCH_QUEUE_PRIORITY_LOW</td>
<td align="center">NSQualityOfServiceUtility</td>
<td align="center">èŠ±è´¹æ—¶é—´ç¨å¤šæ¯”å¦‚ä¸‹è½½ï¼Œéœ€è¦å‡ ç§’æˆ–å‡ åˆ†é’Ÿçš„ã€‚</td>
</tr>
<tr>
<td align="center">DISPATCH_QUEUE_PRIORITY_BACKGROUND</td>
<td align="center">NSQualityOfServiceBackground</td>
<td align="center">ä¸å¯è§åœ¨åå°çš„æ“ä½œå¯èƒ½éœ€è¦å¥½å‡ åˆ†é’Ÿç”šè‡³å‡ å°æ—¶çš„ã€‚</td>
</tr>
</tbody></table>

  </div>
</article>


    
<div class="gitalk" id="gitalk-container"></div>
<link rel="stylesheet" href="/gDark.css" media="screen" type="text/css"> 

<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>


<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>

<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: 'c0fd3fecc668416852dc',
    clientSecret: '5f849bbb22f9233b3fe19627c9eb28be39b721d1',
    repo: 'YYBlogGiTalk',
    owner: 'ATommyGirl',
    admin: ['ATommyGirl'],
    // id: location.pathname,      // Ensure uniqueness and length less than 50
    id: md5(location.pathname),
    distractionFreeMode: false,  // Facebook-like distraction free mode
    pagerDirection: 'last'
  })

  gitalk.render('gitalk-container')
</script>


    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>åŠ è½½è¯„è®ºéœ€è¦åœ¨æµè§ˆå™¨å¯ç”¨ JavaScript è„šæœ¬æ”¯æŒã€‚</noscript>
        </div>
    </div>
    



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">å½’æ¡£</a></li>
         
          <li><a href="/tags">æ ‡ç­¾</a></li>
         
          <li><a href="/about">å…³äº</a></li>
         
          <li><a href="/search/">æœç´¢</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#GCD%E6%A6%82%E8%A6%81"><span class="toc-number">1.</span> <span class="toc-text">GCDæ¦‚è¦</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">åŸºæœ¬æ¦‚å¿µ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E3%80%81-%E7%B3%BB%E7%BB%9F%E6%A0%87%E5%87%86%E4%B8%A4%E4%B8%AA%E9%98%9F%E5%88%97"><span class="toc-number">1.1.1.</span> <span class="toc-text">ä¸€ã€ ç³»ç»Ÿæ ‡å‡†ä¸¤ä¸ªé˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E9%98%9F%E5%88%97"><span class="toc-number">1.1.2.</span> <span class="toc-text">äºŒã€è‡ªå®šä¹‰é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%90%8C%E6%AD%A5%E5%BC%82%E6%AD%A5%E7%BA%BF%E7%A8%8B%E5%88%9B%E5%BB%BA"><span class="toc-number">1.1.3.</span> <span class="toc-text">ä¸‰ã€åŒæ­¥å¼‚æ­¥çº¿ç¨‹åˆ›å»º</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%9F%E5%88%97%EF%BC%88dispatch-queue%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">é˜Ÿåˆ—ï¼ˆdispatch queueï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-number">2.1.</span> <span class="toc-text">åŸºæœ¬ç”¨æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E3%80%81dispatch-get-global-queue"><span class="toc-number">2.1.1.</span> <span class="toc-text">ä¸€ã€dispatch_get_global_queue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E3%80%81dispatch-queue-create"><span class="toc-number">2.1.2.</span> <span class="toc-text">äºŒã€dispatch_queue_create</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%98%9F%E5%88%97%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">2.1.3.</span> <span class="toc-text">ä¸‰ã€é˜Ÿåˆ—ä¼˜å…ˆçº§</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%9F%E5%88%97%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.2.</span> <span class="toc-text">é˜Ÿåˆ—ç±»å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E3%80%815%E7%A7%8D%E9%98%9F%E5%88%97"><span class="toc-number">2.2.1.</span> <span class="toc-text">ä¸€ã€5ç§é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8%E4%BD%95%E7%A7%8D%E9%98%9F%E5%88%97%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.2.2.</span> <span class="toc-text">äºŒã€ä½•æ—¶ä½¿ç”¨ä½•ç§é˜Ÿåˆ—ç±»å‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E3%80%81QoS%E7%AD%89%E7%BA%A7%E5%8F%82%E6%95%B0%E7%9A%84%E5%86%99%E6%B3%95"><span class="toc-number">2.2.3.</span> <span class="toc-text">ä¸‰ã€QoSç­‰çº§å‚æ•°çš„å†™æ³•</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">3.</span> <span class="toc-text">åº”ç”¨åœºæ™¯</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E5%92%8C%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.</span> <span class="toc-text">ç®€å•ä½¿ç”¨å’Œä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E3%80%81dispatch-once%E7%94%A8%E6%B3%95"><span class="toc-number">3.1.1.</span> <span class="toc-text">ä¸€ã€dispatch_onceç”¨æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E3%80%81dispatch-async"><span class="toc-number">3.1.2.</span> <span class="toc-text">äºŒã€dispatch_async</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E3%80%81dispatch-after%E5%BB%B6%E5%90%8E%E6%89%A7%E8%A1%8C"><span class="toc-number">3.1.3.</span> <span class="toc-text">ä¸‰ã€dispatch_afterå»¶åæ‰§è¡Œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B%E3%80%81dispatch-barrier-async%E4%BD%BF%E7%94%A8Barrier-Task%E6%96%B9%E6%B3%95"><span class="toc-number">3.1.4.</span> <span class="toc-text">å››ã€dispatch_barrier_asyncä½¿ç”¨Barrier Taskæ–¹æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%94%E3%80%81dispatch-apply%E8%BF%9B%E8%A1%8C%E5%BF%AB%E9%80%9F%E8%BF%AD%E4%BB%A3"><span class="toc-number">3.1.5.</span> <span class="toc-text">äº”ã€dispatch_applyè¿›è¡Œå¿«é€Ÿè¿­ä»£</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AD%E3%80%81Block%E7%BB%84%E5%90%88Dispatch-groups"><span class="toc-number">3.1.6.</span> <span class="toc-text">å…­ã€Blockç»„åˆDispatch_groups</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%83%E3%80%81Dispatch-Block"><span class="toc-number">3.1.7.</span> <span class="toc-text">ä¸ƒã€Dispatch Block</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#dispatch-block-t-%E5%88%9B%E5%BB%BAblock"><span class="toc-number">3.1.7.1.</span> <span class="toc-text">dispatch_block_t åˆ›å»ºblock</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dispatch-block-wait"><span class="toc-number">3.1.7.2.</span> <span class="toc-text">dispatch_block_wait</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dispatch-block-notify"><span class="toc-number">3.1.7.3.</span> <span class="toc-text">dispatch_block_notify</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dispatch-block-cancel"><span class="toc-number">3.1.7.4.</span> <span class="toc-text">dispatch_block_cancel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8dispatch-block-object%EF%BC%88%E8%B0%83%E5%BA%A6%E5%9D%97%EF%BC%89%E5%9C%A8%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%89%8D%E8%BF%9B%E8%A1%8C%E5%8F%96%E6%B6%88"><span class="toc-number">3.1.7.5.</span> <span class="toc-text">ä½¿ç”¨dispatch block objectï¼ˆè°ƒåº¦å—ï¼‰åœ¨ä»»åŠ¡æ‰§è¡Œå‰è¿›è¡Œå–æ¶ˆ</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AB%E3%80%81Dispatch-IO-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">3.1.8.</span> <span class="toc-text">å…«ã€Dispatch IO æ–‡ä»¶æ“ä½œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B9%9D%E3%80%81Dispatch-Source-%E7%94%A8GCD%E7%9B%91%E8%A7%86%E8%BF%9B%E7%A8%8B"><span class="toc-number">3.1.9.</span> <span class="toc-text">ä¹ã€Dispatch Source ç”¨GCDç›‘è§†è¿›ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%81%E3%80%81Dispatch-Semaphore%E5%92%8C%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.10.</span> <span class="toc-text">åã€Dispatch Semaphoreå’Œçš„ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E9%94%81"><span class="toc-number">3.1.11.</span> <span class="toc-text">åä¸€ã€é”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81dispatch-suspend%E5%92%8Cdispatch-resume%E6%8C%82%E8%B5%B7%E5%92%8C%E6%81%A2%E5%A4%8D%E9%98%9F%E5%88%97"><span class="toc-number">3.1.12.</span> <span class="toc-text">åäºŒã€dispatch_suspendå’Œdispatch_resumeæŒ‚èµ·å’Œæ¢å¤é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%81%E4%B8%89%E3%80%81dispatch-set-context%E5%92%8Cdispatch-get-context"><span class="toc-number">3.1.13.</span> <span class="toc-text">åä¸‰ã€dispatch_set_contextå’Œdispatch_get_context</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GCD%E6%B7%B1%E5%85%A5%E6%93%8D%E4%BD%9C"><span class="toc-number">4.</span> <span class="toc-text">GCDæ·±å…¥æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GCD%E6%AD%BB%E9%94%81"><span class="toc-number">4.1.</span> <span class="toc-text">GCDæ­»é”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GCD%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">GCDå®é™…ä½¿ç”¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#iOS%E7%B3%BB%E7%BB%9F%E7%89%88%E6%9C%AC%E6%96%B0%E7%89%B9%E6%80%A7"><span class="toc-number">5.</span> <span class="toc-text">iOSç³»ç»Ÿç‰ˆæœ¬æ–°ç‰¹æ€§</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#iOS8"><span class="toc-number">5.1.</span> <span class="toc-text">iOS8</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://tommygirl.cn/2016/01/13/GCD/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://tommygirl.cn/2016/01/13/GCD/&text=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://tommygirl.cn/2016/01/13/GCD/&title=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://tommygirl.cn/2016/01/13/GCD/&is_video=false&description=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)&body=Check out this article: https://tommygirl.cn/2016/01/13/GCD/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://tommygirl.cn/2016/01/13/GCD/&title=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://tommygirl.cn/2016/01/13/GCD/&title=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://tommygirl.cn/2016/01/13/GCD/&title=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://tommygirl.cn/2016/01/13/GCD/&title=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://tommygirl.cn/2016/01/13/GCD/&name=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)&description=&lt;p&gt;è½¬è½½è‡ª &lt;a href=&#34;https://github.com/ming1016&#34;&gt;æˆ´é“­è€å¸ˆ&lt;/a&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;æ–‡ä¸­è¾ƒè¯¦ç»†ä»‹ç»GCDé˜Ÿåˆ—ï¼Œå„ç§GCDä½¿ç”¨æ–¹æ³•ï¼Œå®ä¾‹å¦‚ä½•ä½¿ç”¨Dispatch Sourceç›‘å¬ç³»ç»Ÿåº•å±‚å¯¹è±¡ï¼Œåˆ†æä¸åŒé”çš„æ€§èƒ½å¯¹æ¯”ï¼Œå®ä¾‹GCDæ­»é”æƒ…å†µã€‚ &lt;/p&gt;
&lt;p&gt;æ–‡ä¸­çš„Demoåœ¨è¿™é‡Œ &lt;a href=&#34;https://github.com/ming1016/GCDDemo&#34;&gt;Demo&lt;/a&gt; å¯¹ç€æ–‡ç« è¯•ç€æ¥è°ƒdemoä½“ä¼šæ›´æ·±å“¦ï¼Œç»†ç»†åš¼æ¶ˆåŒ–å¥½ğŸ¤“&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://tommygirl.cn/2016/01/13/GCD/&t=ã€è½¬è½½ã€‘GCD (Grand Central Dispatch)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> èœå•</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> ç›®å½•</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> åˆ†äº«</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> è¿”å›é¡¶éƒ¨</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">å½’æ¡£</a></li>
         
          <li><a href="/tags">æ ‡ç­¾</a></li>
         
          <li><a href="/about">å…³äº</a></li>
         
          <li><a href="/search/">æœç´¢</a></li>
        
      </ul>
    </nav> 
  </div>
  <div class="footer-right">
      YYLittleCat
      Copyright &copy;
      
      
      2015-2022
  </div>
  <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn">æ´¥ICPå¤‡2021005176å·</a>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"å¤åˆ¶åˆ°ç²˜è´´æ¿!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "å¤åˆ¶æˆåŠŸ!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"left","width":300,"height":600,"vOffset":-100,"hOffset":50},"mobile":{"show":false},"log":false});</script></body>
</html>
